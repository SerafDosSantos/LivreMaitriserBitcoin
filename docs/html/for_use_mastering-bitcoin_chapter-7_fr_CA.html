<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Transactions et scripts avanc√©s</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article data-line-1">
<div id="header">
</div>
<div id="content">
<div class="sect1 data-line-3">
<h2 id="adv_transactions">Transactions et scripts avanc√©s</h2>
<div class="sectionbody">
<div class="sect2 data-line-6">
<h3 id="ch07_intro">Pr√©sentation</h3>
<div class="paragraph data-line-8">
<p>Dans le chapitre pr√©c√©dent, nous avons pr√©sent√© les √©l√©ments de base des transactions bitcoin et examin√© le type de script de transaction le plus courant, le script P2PKH. Dans ce chapitre, nous examinerons des scripts plus avanc√©s et comment nous pouvons les utiliser pour cr√©er des transactions avec des conditions complexes.</p>
</div>
<div class="paragraph data-line-10">
<p>Tout d&#8217;abord, nous examinerons les scripts <em>multisignature</em>. Ensuite, nous examinerons le deuxi√®me script de transaction le plus courant, <em>Pay-to-Script-Hash</em>, qui ouvre tout un monde de scripts complexes. Ensuite, nous examinerons de nouveaux op√©rateurs de script qui ajoutent une dimension temporelle au bitcoin, via les <em>timelocks</em> (verrouillage temporel). Enfin, nous examinerons les <em>Segregated Witness</em> (t√©moins s√©par√©s), une modification architecturale de la structure des transactions.</p>
</div>
</div>
<div class="sect2 data-line-13">
<h3 id="multisig">Multisignature</h3>
<div class="paragraph data-line-15">
<p>Les scripts multisignatures d√©finissent une condition dans laquelle N cl√©s publiques sont enregistr√©es dans le script et au moins M d&#8217;entre elles doivent fournir des signatures pour d√©bloquer les fonds. Ceci est √©galement connu sous le nom de sch√©ma M-sur-N, o√π N est le nombre total de cl√©s et M est le seuil de signatures requises pour la validation. Par exemple, une multisignature 2 sur 3 est celle o√π trois cl√©s publiques sont r√©pertori√©es comme signataires potentiels et au moins deux d&#8217;entre elles doivent √™tre utilis√©es pour cr√©er des signatures pour une transaction valide afin de d√©penser les fonds.</p>
</div>
<div class="paragraph data-line-17">
<p>√Ä l&#8217;heure actuelle, les scripts multisignatures <em>standard</em> sont limit√©s √† un maximum de 3 cl√©s publiques r√©pertori√©es, ce qui signifie que vous pouvez faire n&#8217;importe quoi d&#8217;une multisignature 1 sur 1 jusqu&#8217;√† 3 sur 3 ou toute combinaison dans cette plage. La limitation √† 3 cl√©s r√©pertori√©es pourrait √™tre lev√©e au moment de la publication de ce livre, alors v√©rifiez la fonction <code>IsStandard()</code> pour voir ce qui est actuellement accept√© par le r√©seau. Notez que la limite de 3 cl√©s s&#8217;applique uniquement aux scripts multisignatures standard (√©galement appel√©s "nus (bare en anglais)"), et non aux scripts multisignatures envelopp√©s dans un script Pay-to-Script-Hash (P2SH). Les scripts multisignatures P2SH sont limit√©s √† 15 cl√©s, permettant jusqu&#8217;√† 15 multisignatures sur 15. Cette limitation est √©galement impos√©e par la fonction <code>IsStandard()</code>. Nous en apprendrons davantage sur P2SH dans <a href="#p2sh">Pay-to-Script-Hash (P2SH)</a>.</p>
</div>
<div class="paragraph data-line-19">
<p>La forme g√©n√©rale d&#8217;un script de verrouillage d√©finissant une condition multisignature M-de-N est¬†:</p>
</div>
<div class="listingblock data-line-21">
<div class="content">
<pre>M &lt;Public Key 1&gt; &lt;Public Key 2&gt; ... &lt;Public Key N&gt; N CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-25">
<p>o√π N est le nombre total de cl√©s publiques r√©pertori√©es et M est le seuil de signatures requises pour d√©penser la sortie.</p>
</div>
<div class="paragraph data-line-27">
<p>Un script de verrouillage d√©finissant une condition multisignature 2 sur 3 ressemble √† ceci¬†:</p>
</div>
<div class="listingblock data-line-29">
<div class="content">
<pre>2 &lt;Public Key A&gt; &lt;Public Key B&gt; &lt;Public Key C&gt; 3 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-33">
<p>Le script de verrouillage pr√©c√©dent peut se contenter d&#8217;un script de d√©verrouillage contenant n&#8217;importe quelle combinaison de deux signatures issues des cl√©s priv√©es correspondant aux trois cl√©s publiques list√©es :</p>
</div>
<div class="listingblock data-line-35">
<div class="content">
<pre>&lt;Signature B&gt; &lt;Signature C&gt;</pre>
</div>
</div>
<div class="paragraph data-line-39">
<p>Les deux scripts ensemble formeraient le script de validation combin√©¬†:</p>
</div>
<div class="listingblock data-line-41">
<div class="content">
<pre>&lt;Signature B&gt; &lt;Signature C&gt; 2 &lt;Public Key A&gt; &lt;Public Key B&gt; &lt;Public Key C&gt; 3 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-45">
<p>Lorsqu&#8217;il est ex√©cut√©, ce script combin√© sera √©valu√© √† TRUE si, et seulement si, le script de d√©verrouillage correspond aux conditions d√©finies par le script de verrouillage. Dans ce cas, la condition est de savoir si le script de d√©verrouillage poss√®de une signature valide √† partir des deux cl√©s priv√©es qui correspondent √† deux des trois cl√©s publiques d√©finies comme une charge.</p>
</div>
<div class="sect3 data-line-48">
<h4 id="multisig_bug">Un bogue dans l&#8217;ex√©cution de CHECKMULTISIG</h4>
<div class="paragraph data-line-50">
<p>Il y a un bug dans l&#8217;ex√©cution de <code>CHECKMULTISIG</code> qui n√©cessite une l√©g√®re solution de contournement. Lorsque <code>CHECKMULTISIG</code> s&#8217;ex√©cute, il doit consommer M`N`2 √©l√©ments sur la pile en tant que param√®tres. Cependant, en raison du bogue, <code>CHECKMULTISIG</code> affichera une valeur suppl√©mentaire ou une valeur de plus que pr√©vu.</p>
</div>
<div class="paragraph data-line-52">
<p>Examinons cela plus en d√©tail √† l&#8217;aide de l&#8217;exemple de validation pr√©c√©dent¬†:</p>
</div>
<div class="listingblock data-line-54">
<div class="content">
<pre>&lt;Signature B&gt; &lt;Signature C&gt; 2 &lt;Public Key A&gt; &lt;Public Key B&gt; &lt;Public Key C&gt; 3 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-58">
<p>Tout d&#8217;abord, <code>CHECKMULTISIG</code> affiche l&#8217;√©l√©ment sup√©rieur, qui est <code>N</code> (dans cet exemple "3"). Ensuite, il affiche <code>N</code> √©l√©ments, qui sont les cl√©s publiques pouvant signer. Dans cet exemple, les cl√©s publiques A, B et C. Ensuite, un √©l√©ment appara√Æt, qui est <code>M</code>, le quorum (combien de signatures sont n√©cessaires). Ici M = 2. √Ä ce stade, <code>CHECKMULTISIG</code> devrait faire appara√Ætre les √©l√©ments finaux <code>M</code>, qui sont les signatures, et voir s&#8217;ils sont valides. Cependant, malheureusement, un bogue dans l&#8217;impl√©mentation fait que <code>CHECKMULTISIG</code> affiche un √©l√©ment de plus (M+1 total) qu&#8217;il ne le devrait. L&#8217;√©l√©ment suppl√©mentaire n&#8217;est pas pris en compte lors de la v√©rification des signatures, il n&#8217;a donc aucun effet direct sur <code>CHECKMULTISIG</code> lui-m√™me. Cependant, une valeur suppl√©mentaire doit √™tre pr√©sente car si elle n&#8217;est pas pr√©sente, lorsque <code>CHECKMULTISIG</code> tente d&#8217;appara√Ætre sur une pile vide, cela provoquera une erreur de pile et un √©chec du script (marquant la transaction comme invalide). Comme l&#8217;√©l√©ment suppl√©mentaire n&#8217;est pas pris en compte, il peut s&#8217;agir de n&#8217;importe quoi, mais habituellement <code>0</code> est utilis√©.</p>
</div>
<div class="paragraph data-line-60">
<p>Parce que ce bogue est devenu une partie des r√®gles de consensus, il doit maintenant √™tre r√©pliqu√© pour toujours. Par cons√©quent, la validation correcte du script ressemblerait √† ceci¬†:</p>
</div>
<div class="listingblock data-line-62">
<div class="content">
<pre>0 &lt;Signature B&gt; &lt;Signature C&gt; 2 &lt;Public Key A&gt; &lt;Public Key B&gt; &lt;Public Key C&gt; 3 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-66">
<p>Ainsi le script de d√©verrouillage r√©ellement utilis√© en multisig n&#8217;est pas :</p>
</div>
<div class="listingblock data-line-68">
<div class="content">
<pre>&lt;Signature B&gt; &lt;Signature C&gt;</pre>
</div>
</div>
<div class="paragraph data-line-72">
<p>mais √† la place c&#8217;est :</p>
</div>
<div class="listingblock data-line-74">
<div class="content">
<pre>0 &lt;Signature B&gt; &lt;Signature C&gt;</pre>
</div>
</div>
<div class="paragraph data-line-78">
<p>√Ä partir de maintenant, si vous voyez un script de d√©verrouillage multisig, vous devriez vous attendre √† voir un <code>0</code> suppl√©mentaire au d√©but, dont le seul but est de contourner un bogue qui est accidentellement devenu une r√®gle de consensus.</p>
</div>
</div>
</div>
<div class="sect2 data-line-81">
<h3 id="p2sh">Pay-to-Script-Hash (P2SH)</h3>
<div class="paragraph data-line-83">
<p>Pay- to-Script-Hash (P2SH) a √©t√© introduit en 2012 en tant que nouveau type de transaction puissant qui simplifie grandement l&#8217;utilisation de scripts de transaction complexes. Pour expliquer le besoin de P2SH, regardons un exemple pratique.</p>
</div>
<div class="paragraph data-line-85">
<p>("Pay-to-Script-Hash (P2SH)", "exemple d&#8217;import/export")Dans <a href="#ch01_intro_what_is_bitcoin">[ch01_intro_what_is_bitcoin]</a> nous avons pr√©sent√© Mohammed, un importateur d&#8217;√©lectronique bas√© √† Duba√Ø. La soci√©t√© de Mohammed utilise largement la fonction multisignature de Bitcoin pour ses comptes d&#8217;entreprise. Les scripts multisignatures sont l&#8217;une des utilisations les plus courantes des capacit√©s de script avanc√©es de Bitcoin et constituent une fonctionnalit√© tr√®s puissante. La soci√©t√© de Mohammed utilise un script multisignature pour tous les paiements des clients, connu en termes comptables sous le nom de "comptes d√©biteurs ou recevables". Avec le sch√©ma multisignature, tous les paiements effectu√©s par les clients sont verrouill√©s de telle mani√®re qu&#8217;ils n√©cessitent au moins deux signatures pour √™tre lib√©r√©s, de Mohammed et de l&#8217;un de ses partenaires ou de son avocat qui dispose d&#8217;une cl√© de secours. Un syst√®me multisignature comme celui-ci offre des contr√¥les de gouvernance d&#8217;entreprise et prot√®ge contre le vol, le d√©tournement de fonds ou la perte.</p>
</div>
<div class="paragraph data-line-87">
<p>Le script r√©sultant est assez long et ressemble √† ceci¬†:</p>
</div>
<div class="listingblock data-line-89">
<div class="content">
<pre>2 &lt;Mohammed's Public Key&gt; &lt;Partner1 Public Key&gt; &lt;Partner2 Public Key&gt; &lt;Partner3 Public Key&gt; &lt;Attorney Public Key&gt; 5 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-93">
<p>Bien que les scripts multisignatures soient une fonctionnalit√© puissante, ils sont lourds √† utiliser. Compte tenu du script pr√©c√©dent, Mohammed devrait communiquer ce script √† chaque client avant le paiement. Chaque client devrait utiliser un logiciel sp√©cial de portefeuille bitcoin avec la possibilit√© de cr√©er des scripts de transaction personnalis√©s, et chaque client devrait comprendre comment cr√©er une transaction √† l&#8217;aide de scripts personnalis√©s. De plus, la transaction r√©sultante serait environ cinq fois plus importante qu&#8217;une simple transaction de paiement, car ce script contient des cl√©s publiques tr√®s longues. Le fardeau de cette transaction extra-large serait support√© par le client sous la forme de frais. Enfin, un gros script de transaction comme celui-ci serait transport√© dans l&#8217;UTXO d√©fini dans la RAM de chaque n≈ìud complet, jusqu&#8217;√† ce qu&#8217;il soit d√©pens√©. Tous ces probl√®mes rendent difficile l&#8217;utilisation de scripts de verrouillage complexes dans la pratique.</p>
</div>
<div class="paragraph data-line-95">
<p>P2SH a √©t√© d√©velopp√© pour r√©soudre ces difficult√©s pratiques et rendre l&#8217;utilisation de scripts complexes aussi simple qu&#8217;un paiement √† une adresse Bitcoin. Avec les paiements P2SH, le script de verrouillage complexe est remplac√© par son empreinte num√©rique, un hachage cryptographique. Lorsqu&#8217;une transaction tentant de d√©penser l&#8217;UTXO est pr√©sent√©e ult√©rieurement, elle doit contenir le script correspondant au hachage, en plus du script de d√©verrouillage. En termes simples, P2SH signifie "payer √† un script correspondant √† ce hachage, un script qui sera pr√©sent√© plus tard lorsque cette sortie sera d√©pens√©e".</p>
</div>
<div class="paragraph data-line-97">
<p>Dans les transactions P2SH, le script de verrouillage qui est remplac√© par un hachage est appel√© <em>redeem script</em> ou <em>script de rachat</em> car il est pr√©sent√© au syst√®me au moment du rachat plut√¥t que comme un script de verrouillage. <a href="#without_p2sh">Script complexe sans P2SH</a> affiche le script sans P2SH et <a href="#with_p2sh">Script complexe comme P2SH</a> montre le m√™me script encod√© avec P2SH.</p>
</div>
<table id="without_p2sh" class="tableblock frame-all grid-all stretch data-line-101">
<caption class="title">Table 1. Script complexe sans P2SH</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de verrouillage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 PubKey1 PubKey2 PubKey3 PubKey4 PubKey5 5 CHECKMULTISIG</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de d√©verrouillage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 Sig1 Sig2</p></td>
</tr>
</tbody>
</table>
<table id="with_p2sh" class="tableblock frame-all grid-all stretch data-line-108">
<caption class="title">Table 2. Script complexe comme P2SH</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de rachat</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 PubKey1 PubKey2 PubKey3 PubKey4 PubKey5 5 CHECKMULTISIG</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de verrouillage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HASH160 &lt;20-byte hash of redeem script&gt; EQUAL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script de d√©verrouillage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 Sig1 Sig2 &lt;redeem script&gt;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-114">
<p>Comme vous pouvez le voir dans les tableaux, avec P2SH, le script complexe qui d√©taille les conditions de d√©pense de la sortie (script de rachat) n&#8217;est pas pr√©sent√© dans le script de verrouillage. Au lieu de cela, seul un hachage de celui-ci se trouve dans le script de verrouillage et le script de rachat lui-m√™me est pr√©sent√© plus tard, dans le cadre du script de d√©verrouillage lorsque la sortie est d√©pens√©e. Cela d√©place le fardeau des frais et de la complexit√© de l&#8217;exp√©diteur (qui cr√©e la transaction) vers le destinataire (qui d√©verrouille et d√©pense la transaction).</p>
</div>
<div class="paragraph data-line-116">
<p>Examinons la soci√©t√© de Mohammed, le script multisignature complexe et les scripts P2SH qui en r√©sultent.</p>
</div>
<div class="paragraph data-line-118">
<p>Tout d&#8217;abord, le script multisignature que la soci√©t√© de Mohammed utilise pour tous les paiements entrants des clients¬†:</p>
</div>
<div class="listingblock data-line-120">
<div class="content">
<pre>2 &lt;Mohammed's Public Key&gt; &lt;Partner1 Public Key&gt; &lt;Partner2 Public Key&gt; &lt;Partner3 Public Key&gt; &lt;Attorney Public Key&gt; 5 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-124">
<p>Si les espaces r√©serv√©s sont remplac√©s par des cl√©s publiques r√©elles (affich√©es ici sous forme de nombres de 520¬†bits commen√ßant par 04), vous pouvez voir que ce script devient tr√®s long¬†:</p>
</div>
<div class="listingblock data-line-126">
<div class="content">
<pre>2
04C16B8698A9ABF84250A7C3EA7EEDEF9897D1C8C6ADF47F06CF73370D74DCCA01CDCA79DCC5C395D7EEC6984D83F1F50C900A24DD47F569FD4193AF5DE762C58704A2192968D8655D6A935BEAF2CA23E3FB87A3495E7AF308EDF08DAC3C1FCBFC2C75B4B0F4D0B1B70CD2423657738C0C2B1D5CE65C97D78D0E34224858008E8B49047E63248B75DB7379BE9CDA8CE5751D16485F431E46117B9D0C1837C9D5737812F393DA7D4420D7E1A9162F0279CFC10F1E8E8F3020DECDBC3C0DD389D99779650421D65CBD7149B255382ED7F78E946580657EE6FDA162A187543A9D85BAAA93A4AB3A8F044DADA618D087227440645ABE8A35DA8C5B73997AD343BE5C2AFD94A5043752580AFA1ECED3C68D446BCAB69AC0BA7DF50D56231BE0AABF1FDEEC78A6A45E394BA29A1EDF518C022DD618DA774D207D137AAB59E0B000EB7ED238F4D800 5 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-131">
<p>Ce script entier peut √† la place √™tre repr√©sent√© par un hachage cryptographique de 20 octets, en appliquant d&#8217;abord l&#8217;algorithme de hachage SHA256, puis en appliquant l&#8217;algorithme RIPEMD160 sur le r√©sultat.</p>
</div>
<div class="paragraph data-line-133">
<p>Nous utilisons <code>libbitcoin-explorer</code> (bx) sur la ligne de commande pour produire le hachage du script, comme suit¬†:</p>
</div>
<div class="listingblock data-line-135">
<div class="content">
<pre>echo \
2 \
[04C16B8698A9ABF84250A7C3EA7EEDEF9897D1C8C6ADF47F06CF73370D74DCCA01CDCA79DCC5C395D7EEC6984D83F1F50C900A24DD47F569FD4193AF5DE762C587] \
[04A2192968D8655D6A935BEAF2CA23E3FB87A3495E7AF308EDF08DAC3C1FCBFC2C75B4B0F4D0B1B70CD2423657738C0C2B1D5CE65C97D78D0E34224858008E8B49] \
[047E63248B75DB7379BE9CDA8CE5751D16485F431E46117B9D0C1837C9D5737812F393DA7D4420D7E1A9162F0279CFC10F1E8E8F3020DECDBC3C0DD389D9977965] \
[0421D65CBD7149B255382ED7F78E946580657EE6FDA162A187543A9D85BAAA93A4AB3A8F044DADA618D087227440645ABE8A35DA8C5B73997AD343BE5C2AFD94A5] \
[043752580AFA1ECED3C68D446BCAB69AC0BA7DF50D56231BE0AABF1FDEEC78A6A45E394BA29A1EDF518C022DD618DA774D207D137AAB59E0B000EB7ED238F4D800] \
5 CHECKMULTISIG \
| bx script-encode | bx sha256 | bx ripemd160
54c557e07dde5bb6cb791c7a540e0a4796f5e97e</pre>
</div>
</div>
<div class="paragraph data-line-148">
<p>La s√©rie de commandes ci-dessus encode d&#8217;abord le script de rachat multisig de Mohammed en tant que script bitcoin s√©rialis√© encod√© en hexad√©cimal. La commande <code>bx</code> suivante calcule le hachage SHA256 de cela. La prochaine commande <code>bx</code> hache √† nouveau avec RIPEMD160, produisant le hachage de script final¬†:</p>
</div>
<div class="paragraph data-line-150">
<p>Le hachage de 20¬†octets du script de rachat de Mohammed est¬†:</p>
</div>
<div class="listingblock data-line-152">
<div class="content">
<pre>54c557e07dde5bb6cb791c7a540e0a4796f5e97e</pre>
</div>
</div>
<div class="paragraph data-line-156">
<p>Une transaction P2SH verrouille la sortie sur ce hachage au lieu du script de rachat plus long, en utilisant le script de verrouillage¬†:</p>
</div>
<div class="listingblock data-line-158">
<div class="content">
<pre>HASH160 54c557e07dde5bb6cb791c7a540e0a4796f5e97e EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-162">
<p>qui, comme vous pouvez le voir, est beaucoup plus courte. Au lieu de "payer √† ce script multisignature √† 5¬†cl√©s", la transaction √©quivalente √† P2SH est "payer √† un script avec ce hachage". Un client effectuant un paiement √† la soci√©t√© de Mohammed n&#8217;a qu&#8217;√† inclure ce script de verrouillage beaucoup plus court dans son paiement. Lorsque Mohammed et ses partenaires veulent d√©penser cet UTXO, ils doivent pr√©senter le script de rachat original (celui dont le hachage a verrouill√© l&#8217;UTXO) et les signatures n√©cessaires pour le d√©verrouiller, comme ceci¬†:</p>
</div>
<div class="listingblock data-line-164">
<div class="content">
<pre>&lt;Sig1&gt; &lt;Sig2&gt; &lt;2 PK1 PK2 PK3 PK4 PK5 5 CHECKMULTISIG&gt;</pre>
</div>
</div>
<div class="paragraph data-line-168">
<p>Les deux scripts sont combin√©s en deux √©tapes. Tout d&#8217;abord, le script de rachat est v√©rifi√© par rapport au script de verrouillage pour s&#8217;assurer que le hachage correspond¬†:</p>
</div>
<div class="listingblock data-line-170">
<div class="content">
<pre>&lt;2 PK1 PK2 PK3 PK4 PK5 5 CHECKMULTISIG&gt; HASH160 &lt;redeem scriptHash&gt; EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-173">
<p>Si le hachage du script de rachat correspond, le script de d√©verrouillage est ex√©cut√© de lui-m√™me pour d√©verrouiller le script de rachat¬†:</p>
</div>
<div class="listingblock data-line-175">
<div class="content">
<pre>&lt;Sig1&gt; &lt;Sig2&gt; 2 PK1 PK2 PK3 PK4 PK5 5 CHECKMULTISIG</pre>
</div>
</div>
<div class="paragraph data-line-179">
<p>Presque tous les scripts d√©crits dans ce chapitre ne peuvent √™tre impl√©ment√©s qu&#8217;en tant que scripts P2SH. Par exemple, un script de verrouillage multisignature standard 2 sur 5 ne peut pas √™tre utilis√© directement dans le script de verrouillage d&#8217;un UTXO, car <code>IsStandard()</code> invaliderait la transaction. Pour se conformer, un script de verrouillage P2SH peut √™tre utilis√© √† la place, comme vu ci-dessus. Une transaction qui comprend alors un script de d√©verrouillage P2SH peut √™tre utilis√©e pour racheter cet UTXO et sera valide tant qu&#8217;elle ne contient pas plus de 15 cl√©s publiques. </p>
</div>
<div class="admonitionblock tip data-line-182">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-183">
<p>N&#8217;oubliez pas qu&#8217;en raison de la politique d√©finie par la fonction <code>IsStandard()</code> au moment de la r√©daction de cet article, les scripts multisignatures standard sont limit√©s √† 3 cl√©s publiques r√©pertori√©es au maximum, tandis que les scripts P2SH sont limit√©s √† 15 cl√©s publiques r√©pertori√©es au maximum. Les scripts multisignatures standard peuvent invalider les transactions au moyen de leur script de verrouillage <em>ou</em> de d√©verrouillage, tandis que les scripts P2SH peuvent invalider les transactions au moyen de leur script de d√©verrouillage <em>uniquement</em>. En effet, <code>IsStandard()</code> n&#8217;a aucun moyen de savoir si un hachage d&#8217;un script de rachat dans un script de verrouillage inclut plus de signatures que la limite de taille actuellement impos√©e, il ne peut donc observer que les scripts de d√©verrouillage dans les entr√©es de transaction.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3 data-line-186">
<h4 id="_adresses_p2sh">Adresses P2SH</h4>
<div class="paragraph data-line-188">
<p>Une autre partie importante de la fonctionnalit√© P2SH est la possibilit√© d&#8217;encoder un hachage de script en tant qu&#8217;adresse, comme d√©fini dans BIP-13. Les adresses P2SH sont des encodages Base58Check du hachage de 20 octets d&#8217;un script, tout comme les adresses Bitcoin sont des encodages Base58Check du hachage de 20 octets d&#8217;une cl√© publique. Les adresses P2SH utilisent le pr√©fixe de version "5", ce qui donne des adresses encod√©es en Base58Check qui commencent par un "3".</p>
</div>
<div class="paragraph data-line-190">
<p>Par exemple, le script complexe de Mohammed, hach√© et encod√© en Base58Check comme une adresse P2SH, devient 39RF6JqABiHdYHkfChV6USGMe6Nsr66Gzw. Nous pouvons le confirmer avec la commande bx¬†:</p>
</div>
<div class="listingblock data-line-192">
<div class="content">
<pre>echo \
'54c557e07dde5bb6cb791c7a540e0a4796f5e97e'\
 | bx address-encode -v 5
39RF6JqABiHdYHkfChV6USGMe6Nsr66Gzw</pre>
</div>
</div>
<div class="paragraph data-line-200">
<p>Maintenant, Mohammed peut donner cette "adresse" √† ses clients et ils peuvent utiliser presque n&#8217;importe quel portefeuille bitcoin pour effectuer un paiement simple, comme s&#8217;il s&#8217;agissait d&#8217;une adresse Bitcoin. Le pr√©fixe 3 leur donne un indice qu&#8217;il s&#8217;agit d&#8217;un type d&#8217;adresse sp√©cial, celui correspondant √† un script au lieu d&#8217;une cl√© publique, mais sinon cela fonctionne exactement de la m√™me mani√®re qu&#8217;un paiement √† une adresse Bitcoin.</p>
</div>
<div class="paragraph data-line-202">
<p>Les adresses P2SH cachent toute la complexit√©, de sorte que la personne effectuant un paiement ne voit pas le script.</p>
</div>
</div>
<div class="sect3 data-line-204">
<h4 id="_avantages_du_p2sh">Avantages du P2SH</h4>
<div class="paragraph data-line-206">
<p>La fonction P2SH offre les avantages suivants par rapport √† l&#8217;utilisation directe de scripts complexes dans le verrouillage des sorties¬†:</p>
</div>
<div class="ulist data-line-208">
<ul>
<li class="data-line-208">
<p>Les scripts complexes sont remplac√©s par des empreintes digitales plus courtes dans la sortie de la transaction, ce qui r√©duit la taille de la transaction.</p>
</li>
<li class="data-line-209">
<p>Les scripts peuvent √™tre cod√©s comme une adresse, de sorte que l&#8217;exp√©diteur et le portefeuille de l&#8217;exp√©diteur n&#8217;ont pas besoin d&#8217;ing√©nierie complexe pour impl√©menter P2SH.</p>
</li>
<li class="data-line-210">
<p>P2SH transf√®re le fardeau de la construction du script au destinataire, pas √† l&#8217;exp√©diteur.</p>
</li>
<li class="data-line-211">
<p>P2SH d√©place la charge de stockage des donn√©es pour le script long de la sortie (qui en plus d&#8217;√™tre stock√©e sur la cha√Æne de blocs est dans l&#8217;ensemble UTXO) vers l&#8217;entr√©e (uniquement stock√©e sur la cha√Æne de blocs).</p>
</li>
<li class="data-line-212">
<p>P2SH d√©place la charge de stockage des donn√©es pour le script long du moment pr√©sent (paiement) √† un moment futur (lorsqu&#8217;il est d√©pens√©).</p>
</li>
<li class="data-line-213">
<p>P2SH transf√®re les frais de transaction plus √©lev√©s d&#8217;un long script de l&#8217;exp√©diteur au destinataire, qui doit inclure le long script d&#8217;√©change pour le d√©penser.</p>
</li>
</ul>
</div>
</div>
<div class="sect3 data-line-215">
<h4 id="_utiliser_le_script_et_la_validation">Utiliser le script et la validation</h4>
<div class="paragraph data-line-217">
<p>Avant la version 0.9.2 du client Bitcoin Core, Pay-to-Script-Hash √©tait limit√© aux types standard de scripts de transaction bitcoin, par la fonction IsStandard(). Cela signifie que le script d&#8217;√©change pr√©sent√© dans la transaction de d√©penses ne peut √™tre que l&#8217;un des types standard¬†: P2PK, P2PKH ou multisig.</p>
</div>
<div class="paragraph data-line-219">
<p>Depuis la version 0.9.2 du client Bitcoin Core, les transactions P2SH peuvent contenir n&#8217;importe quel script valide, ce qui rend la norme P2SH beaucoup plus flexible et permet d&#8217;exp√©rimenter de nombreux types de transactions nouveaux et complexes.</p>
</div>
<div class="paragraph data-line-221">
<p>Vous ne pouvez pas mettre un P2SH dans un script de rachat P2SH, car la sp√©cification P2SH n&#8217;est pas r√©cursive. Aussi, bien qu&#8217;il soit techniquement possible d&#8217;inclure <code>RETURN</code> (voir <a href="#op_return">Sortie d&#8217;enregistrement de donn√©es (RETURN)</a>) dans un script de rachat, comme rien dans les r√®gles ne vous emp√™che de le faire, cela n&#8217;a aucune utilit√© pratique car l&#8217;ex√©cution de <code>RETURN</code> lors de la validation entra√Ænera le marquage de la transaction comme invalide.</p>
</div>
<div class="paragraph data-line-223">
<p>Notez que, comme le script de rachat n&#8217;est pas pr√©sent√© au r√©seau tant que vous n&#8217;essayez pas de d√©penser une sortie P2SH, si vous verrouillez une sortie avec le hachage d&#8217;un script de rachat invalide, elle sera trait√©e malgr√© tout. L&#8217;UTXO sera verrouill√© avec succ√®s. Cependant, vous ne pourrez pas le d√©penser car la transaction de d√©pense, qui inclut le script d&#8217;√©change, ne sera pas accept√©e car il s&#8217;agit d&#8217;un script invalide. Cela cr√©e un risque, car vous pouvez verrouiller des bitcoins dans un P2SH qui ne pourra pas √™tre d√©pens√© plus tard. Le r√©seau acceptera le script de verrouillage P2SH m√™me s&#8217;il correspond √† un script de rachat invalide, car le hachage du script ne donne aucune indication sur le script qu&#8217;il repr√©sente.</p>
</div>
<div class="admonitionblock warning data-line-226">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-227">
<p>Les scripts de verrouillage P2SH contiennent le hachage d&#8217;un script de rachat, qui ne donne aucun indice quant au contenu du script de rachat lui-m√™me. La transaction P2SH sera consid√©r√©e comme valide et accept√©e m√™me si le script de rachat est invalide. Vous pourriez accidentellement verrouiller le bitcoin de telle sorte qu&#8217;il ne puisse plus √™tre d√©pens√©.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2 data-line-233">
<h3 id="op_return">Sortie d&#8217;enregistrement de donn√©es (RETURN)</h3>
<div class="paragraph data-line-235">
<p>Les bitcoins sont distribu√©s et Le grand livre horodat√©, la cha√Æne de blocs, a des utilisations potentielles bien au-del√† des paiements. De nombreux d√©veloppeurs ont essay√© d&#8217;utiliser le langage de script de transaction pour tirer parti de la s√©curit√© et de la r√©silience du syst√®me pour des applications telles que les services de notaire num√©rique, les certificats d&#8217;actions et les contrats intelligents. Les premi√®res tentatives d&#8217;utilisation du langage de script de bitcoin √† ces fins impliquaient la cr√©ation de sorties de transaction qui enregistraient des donn√©es sur la cha√Æne de blocs; par exemple, pour enregistrer une empreinte digitale d&#8217;un fichier de mani√®re √† ce que n&#8217;importe qui puisse √©tablir la preuve de l&#8217;existence de ce fichier √† une date pr√©cise par r√©f√©rence √† cette transaction.</p>
</div>
<div class="paragraph data-line-237">
<p>L&#8217;utilisation de la cha√Æne de blocs de Bitcoin pour stocker les donn√©es non li√©es aux paiements en bitcoins sont un sujet controvers√©. De nombreux d√©veloppeurs consid√®rent cette utilisation abusive et veulent la d√©courager. D&#8217;autres y voient une d√©monstration des puissantes capacit√©s de la technologie cha√Æne de blocs et souhaitent encourager une telle exp√©rimentation. Ceux qui s&#8217;opposent √† l&#8217;inclusion de donn√©es de non-paiement soutiennent que cela provoque un "gonflement de la cha√Æne de blocs", ce qui impose √† ceux qui ex√©cutent des n≈ìuds Bitcoin complets de supporter le co√ªt du stockage sur disque pour les donn√©es que la cha√Æne de blocs n&#8217;√©tait pas destin√©e √† transporter. De plus, de telles transactions cr√©ent des UTXO qui ne peuvent pas √™tre d√©pens√©s, en utilisant l&#8217;adresse Bitcoin de destination comme un champ libre de 20 octets. Parce que l&#8217;adresse est utilis√©e pour les donn√©es, elle ne correspond pas √† une cl√© priv√©e et l&#8217;UTXO r√©sultant ne peut <em>jamais</em> √™tre d√©pens√©¬†; c&#8217;est un faux paiement. Ces transactions qui ne peuvent jamais √™tre d√©pens√©es ne sont donc jamais supprim√©es de l&#8217;ensemble UTXO et entra√Ænent une augmentation permanente de la taille de la base de donn√©es UTXO, ou un "gonflement".</p>
</div>
<div class="paragraph data-line-239">
<p>Dans la version 0.9 du client Bitcoin Core, un compromis a √©t√© trouv√© avec l&#8217;introduction de l&#8217;op√©rateur RETURN. <code>RETURN</code> permet aux d√©veloppeurs d&#8217;ajouter 80¬†octets de donn√©es de non-paiement √† une sortie de transaction. Cependant, contrairement √† l&#8217;utilisation de "faux" UTXO, l&#8217;op√©rateur <code>RETURN</code> cr√©e une sortie explicitement et <em>manifestement ind√©pensable</em>, qui n&#8217;a pas besoin d&#8217;√™tre stock√©e dans l&#8217;ensemble UTXO. Les sorties <code>RETURN</code> sont enregistr√©es sur la cha√Æne de blocs, elles consomment donc de l&#8217;espace disque et contribuent √† l&#8217;augmentation de la taille de la cha√Æne de blocs, mais elles ne sont pas stock√©es dans l&#8217;ensemble UTXO et ne gonflent donc pas le bassin de m√©moire UTXO et ne surchargent pas les n≈ìuds complets avec plus de d√©penses en RAM.</p>
</div>
<div class="paragraph data-line-241">
<p>Les scripts <code>RETURN</code> ressemblent √† ceci¬†:</p>
</div>
<div class="listingblock data-line-243">
<div class="content">
<pre>RETURN &lt;data&gt;</pre>
</div>
</div>
<div class="paragraph data-line-247">
<p>La portion de donn√©es est limit√©e √† 80 octets et repr√©sente le plus souvent un hachage, comme la sortie de l&#8217;algorithme SHA256 (32 octets). De nombreuses applications mettent un pr√©fixe devant les donn√©es pour aider √† identifier l&#8217;application. Par exemple, le service de notarisation num√©rique <a href="https://proofofexistence.com" data-href="https://proofofexistence.com">Preuve d&#8217;existence</a> utilise le pr√©fixe de 8 octets DOCPROOF, qui est encod√© en ASCII sous la forme <code>44 4f 43 50 52 4f 4f 46</code> en hexad√©cimal.</p>
</div>
<div class="paragraph data-line-249">
<p>Gardez √† l&#8217;esprit qu&#8217;il n&#8217;y a pas de "script de d√©verrouillage" correspondant √† <code>RETURN</code> qui pourrait √©ventuellement √™tre utilis√© pour "passer" une sortie RETURN. L&#8217;int√©r√™t de <code>RETURN</code> est que vous ne pouvez pas d√©penser l&#8217;argent bloqu√© dans cette sortie, et donc il n&#8217;a pas besoin d&#8217;√™tre conserv√© dans l&#8217;ensemble UTXO comme potentiellement d√©pensable - <code>RETURN</code> est <em>manifestement ind√©pensable</em>. <code>RETURN</code> est g√©n√©ralement une sortie avec un montant de z√©ro bitcoin, car tout bitcoin attribu√© √† une telle sortie est effectivement perdu √† jamais. Si un <code>RETURN</code> est r√©f√©renc√© comme entr√©e dans une transaction, le moteur de validation de script arr√™tera l&#8217;ex√©cution du script de validation et marquera la transaction comme invalide. L&#8217;ex√©cution de <code>RETURN</code> provoque essentiellement le script "RETURN" avec un <code>FALSE</code> et s&#8217;arr√™te. Ainsi, si vous r√©f√©rencez accidentellement une sortie <code>RETURN</code> comme entr√©e dans une transaction, cette transaction n&#8217;est pas valide.</p>
</div>
<div class="paragraph data-line-251">
<p>Une transaction standard (c&#8217;est-√†-dire conforme aux v√©rifications IsStandard()) ne peut avoir qu&#8217;une seule sortie RETURN. Cependant, une seule sortie <code>RETURN</code> peut √™tre combin√©e dans une transaction avec des sorties de tout autre type.</p>
</div>
<div class="paragraph data-line-253">
<p>Deux nouvelles options de ligne de commande ont √©t√© ajout√©es dans Bitcoin Core √† partir de la version 0.10. L&#8217;option <code>datacarrier</code> contr√¥le le relais et l&#8217;exploration des transactions RETURN, avec la valeur par d√©faut d√©finie √† "1" pour les autoriser. L&#8217;option <code>datacarriersize</code> prend un argument num√©rique sp√©cifiant la taille maximale en octets du script RETURN, 83 octets par d√©faut, ce qui permet un maximum de 80 octets de donn√©es <code>RETURN</code> plus un octet d&#8217;opcode <code>RETURN</code> et deux octets de Opcode PUSHDATA.</p>
</div>
<div class="admonitionblock note data-line-256">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-257">
<p>RETURN a √©t√© initialement propos√© avec une limite de 80 octets, mais la limite a √©t√© r√©duite √† 40 octets lorsque la fonctionnalit√© a √©t√© publi√©e. En f√©vrier 2015, dans la version 0.10 de Bitcoin Core, la limite a √©t√© relev√©e √† 80 octets. Les n≈ìuds peuvent choisir de ne pas relayer ou exploiter RETURN, ou uniquement de relayer et d&#8217;exploiter <code>RETURN</code> contenant moins de 80 octets de donn√©es.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2 data-line-260">
<h3 id="_verrous_temporels">Verrous temporels</h3>
<div class="paragraph data-line-262">
<p>Les verrous temporels (ou timelocks) sont des restrictions sur les transactions ou les sorties qui ne permettent de d√©penser qu&#8217;apr√®s un certain temps. Bitcoin a eu une fonction de verrouillage du temps au niveau de la transaction depuis le d√©but. Il est impl√©ment√© par le champ <code>nLocktime</code> dans une transaction. Deux nouvelles fonctionnalit√©s de verrou temporel ont √©t√© introduites fin 2015 et mi-2016 qui offrent des verrous temporels de niveau UTXO. Ce sont <code>CHECKLOCKTIMEVERIFY</code> et CHECKSEQUENCEVERIFY.</p>
</div>
<div class="paragraph data-line-264">
<p>Les verrous temporels sont utiles pour postdater les transactions et verrouiller les fonds √† une date future. Plus important encore, les verrous temporels √©tendent les scripts bitcoin dans la dimension du temps, ouvrant la porte √† des contrats intelligents complexes en plusieurs √©tapes.</p>
</div>
<div class="sect3 data-line-267">
<h4 id="transaction_locktime_nlocktime">Temps de verrouillage des transactions (nLocktime)</h4>
<div class="paragraph data-line-269">
<p>Depuis le d√©but, Bitcoin a eu une fonction de timelock au niveau de la transaction. L&#8217;heure de verrouillage de la transaction est un param√®tre au niveau de la transaction (un champ dans la structure des donn√©es de la transaction) qui d√©finit la premi√®re heure √† laquelle une transaction est valide et peut √™tre relay√©e sur le r√©seau ou ajout√©e √† la cha√Æne de blocs. Le verrou temporel est √©galement connu sous le nom de <code>nLocktime</code> √† partir du nom de variable utilis√© dans la base de code Bitcoin Core. Il est d√©fini sur z√©ro dans la plupart des transactions pour indiquer une propagation et une ex√©cution imm√©diates. Si <code>nLocktime</code> est diff√©rent de z√©ro et inf√©rieur √† 500 millions, il est interpr√©t√© comme une hauteur de bloc, ce qui signifie que la transaction n&#8217;est pas valide et n&#8217;est pas relay√©e ou incluse dans la cha√Æne de blocs avant la hauteur de bloc sp√©cifi√©e. S&#8217;il est sup√©rieur ou √©gal √† 500 millions, il est interpr√©t√© comme un horodatage Unix Epoch (secondes depuis le 1er janvier 1970) et la transaction n&#8217;est pas valide avant l&#8217;heure sp√©cifi√©e. Les transactions avec <code>nLocktime</code> sp√©cifiant un bloc ou une heure future doivent √™tre conserv√©es par le syst√®me d&#8217;origine et transmises au r√©seau Bitcoin uniquement apr√®s leur validit√©. Si une transaction est transmise au r√©seau avant le <code>nLocktime</code> sp√©cifi√©, la transaction sera rejet√©e par le premier n≈ìud comme invalide et ne sera pas relay√©e vers les autres n≈ìuds. L&#8217;utilisation de <code>nLocktime</code> √©quivaut √† postdater un ch√®que papier.</p>
</div>
<div class="sect4 data-line-272">
<h5 id="locktime_limitations">Limitations du temps de verrouillage des transactions</h5>
<div class="paragraph data-line-274">
<p>nLocktime a la limitation que s&#8217;il permet de d√©penser certaines sorties dans le futur, il ne rend pas impossible de les d√©penser jusqu&#8217;√† ce moment-l√†. Expliquons cela avec l&#8217;exemple suivant.</p>
</div>
<div class="paragraph data-line-276">
<p>Alice signe une transaction en d√©pensant l&#8217;une de ses sorties √† l&#8217;adresse de Bob, et fixe la transaction <code>nLocktime</code> √† 3 mois dans le futur. Alice envoie cette transaction √† Bob pour la conserver. Avec cette transaction, Alice et Bob savent que¬†:</p>
</div>
<div class="ulist data-line-278">
<ul>
<li class="data-line-278">
<p>Bob ne peut pas transmettre la transaction pour racheter les fonds avant que 3 mois ne se soient √©coul√©s.</p>
</li>
<li class="data-line-279">
<p>Bob peut transmettre la transaction apr√®s 3 mois.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-281">
<p>Toutefois:</p>
</div>
<div class="ulist data-line-283">
<ul>
<li class="data-line-283">
<p>Alice peut cr√©er une autre transaction, en d√©pensant deux fois les m√™mes entr√©es sans temps de verrouillage. Ainsi, Alice peut passer le m√™me UTXO avant que les 3 mois ne se soient √©coul√©s.</p>
</li>
<li class="data-line-284">
<p>Bob n&#8217;a aucune garantie qu&#8217;Alice ne le fera pas.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-286">
<p>Il est important de comprendre les limites de la transaction nLocktime. La seule garantie est que Bob ne pourra pas l&#8217;√©changer avant que 3 mois ne se soient √©coul√©s. Il n&#8217;y a aucune garantie que Bob obtiendra les fonds. Pour obtenir une telle garantie, la restriction de verrouillage temporel doit √™tre plac√©e sur l&#8217;UTXO lui-m√™me et faire partie du script de verrouillage, plut√¥t que sur la transaction. Ceci est r√©alis√© par la forme suivante de timelock, appel√©e Check Lock Time Verify.</p>
</div>
</div>
</div>
<div class="sect3 data-line-288">
<h4 id="_v√©rifier_lheure_de_verrouillage_cltv">V√©rifier l&#8217;heure de verrouillage (CLTV)</h4>
<div class="paragraph data-line-290">
<p>En d√©cembre 2015, une nouvelle forme de verrou temporel a √©t√© introduite dans le bitcoin en tant qu&#8217;embranchement convergent (soft fork) am√©lior√©. Bas√© sur une sp√©cification dans BIP-65, le nouvel op√©rateur de script appel√© <em>CHECKLOCKTIMEVERIFY</em> (<em>CLTV</em>) a √©t√© ajout√© au langage de script. <code>CLTV</code> et est un verrou temporel par sortie, plut√¥t qu&#8217;un verrou temporel par transaction comme c&#8217;est le cas avec nLocktime. Cela permet une plus grande flexibilit√© dans la mani√®re dont les verrous temporels sont appliqu√©s.</p>
</div>
<div class="paragraph data-line-292">
<p>En termes simples, en ajoutant l&#8217;opcode <code>CLTV</code> dans le script de rachat d&#8217;une sortie, cela restreint la sortie, de sorte qu&#8217;elle ne peut √™tre d√©pens√©e qu&#8217;une fois le temps sp√©cifi√© √©coul√©.</p>
</div>
<div class="admonitionblock tip data-line-295">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-296">
<p>Alors que <code>nLocktime</code> est un timelock au niveau de la transaction, <code>CLTV</code> est un timelock bas√© sur la sortie.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-299">
<p>CLTV ne remplace pas nLocktime, mais restreint plut√¥t des UTXO sp√©cifiques de sorte qu&#8217;ils ne peuvent √™tre d√©pens√©s que dans une future transaction avec <code>nLocktime</code> d√©fini sur une valeur sup√©rieure ou √©gale.</p>
</div>
<div class="paragraph data-line-301">
<p>L&#8217;opcode <code>CLTV</code> prend un param√®tre en entr√©e, exprim√© sous la forme d&#8217;un nombre au m√™me format que <code>nLocktime</code> (soit une hauteur de bloc, soit un temps d&#8217;√©poque Unix). Comme indiqu√© par le suffixe VERIFY, <code>CLTV</code> est le type d&#8217;opcode qui arr√™te l&#8217;ex√©cution du script si le r√©sultat est FALSE. Si le r√©sultat est TRUE, l&#8217;ex√©cution continue.</p>
</div>
<div class="paragraph data-line-303">
<p>Pour verrouiller une sortie avec CLTV, vous l&#8217;ins√©rez dans le script de rachat de la sortie dans la transaction qui cr√©e la sortie. Par exemple, si Alice paie l&#8217;adresse de Bob, la sortie contiendra normalement un script P2PKH comme celui-ci¬†:</p>
</div>
<div class="listingblock data-line-305">
<div class="content">
<pre>DUP HASH160 &lt;Hachage cl√© publique de Bob&gt; EQUALVERIFY CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-309">
<p>Pour le verrouiller √† un moment, disons dans 3 mois, la transaction serait une transaction P2SH avec un script de rachat comme celui-ci¬†:</p>
</div>
<div class="listingblock data-line-311">
<div class="content">
<pre>&lt;now + 3 months&gt; CHECKLOCKTIMEVERIFY DROP DUP HASH160&lt;Bob's Public Key Hash&gt; EQUALVERIFIER CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-315">
<p>o√π <code>&lt;now &#43; 3 months&gt;</code> est une hauteur de bloc ou une valeur temporelle estim√©e √† 3¬†mois √† partir du moment o√π la transaction est extraite¬†: hauteur de bloc actuelle &#43; 12¬†960 (blocs) ou heure d&#8217;√©poque Unix actuelle &#43; 7¬†760¬†000 (secondes). Pour l&#8217;instant, ne vous inqui√©tez pas de l&#8217;opcode <code>DROP</code> qui suit CHECKLOCKTIMEVERIFY¬†; cela sera expliqu√© sous peu.</p>
</div>
<div class="paragraph data-line-317">
<p>Lorsque Bob essaie de d√©penser cet UTXO, il construit une transaction qui fait r√©f√©rence √† l&#8217;UTXO comme entr√©e. Il utilise sa signature et sa cl√© publique dans le script de d√©verrouillage de cette entr√©e et d√©finit la transaction <code>nLocktime</code> pour qu&#8217;elle soit √©gale ou sup√©rieure au verrouillage temporel dans l&#8217;ensemble <code>CHECKLOCKTIMEVERIFY</code> Alice. Bob diffuse ensuite la transaction sur le r√©seau Bitcoin.</p>
</div>
<div class="paragraph data-line-319">
<p>La transaction de Bob est √©valu√©e comme suit. Si le param√®tre <code>CHECKLOCKTIMEVERIFY</code> d√©fini par Alice est inf√©rieur ou √©gal au <code>nLocktime</code> de la transaction d√©pensi√®re, l&#8217;ex√©cution du script continue (agit comme si un opcode "no operation" ou NOP √©tait ex√©cut√©). Sinon, l&#8217;ex√©cution du script s&#8217;arr√™te et la transaction est consid√©r√©e comme invalide.</p>
</div>
<div class="paragraph data-line-321">
<p>Plus pr√©cis√©ment, <code>CHECKLOCKTIMEVERIFY</code> √©choue et arr√™te l&#8217;ex√©cution, marquant la transaction invalide si (source¬†: BIP-65)¬†:</p>
</div>
<div class="olist arabic data-line-323">
<ol class="arabic">
<li class="data-line-323">
<p>la pile est vide ; ou</p>
</li>
<li class="data-line-324">
<p>l&#8217;√©l√©ment du haut de la pile est inf√©rieur √† 0¬†; ou</p>
</li>
<li class="data-line-325">
<p>le type de verrou temporel (hauteur versus horodatage) de l&#8217;√©l√©ment de la pile sup√©rieure et le champ <code>nLocktime</code> ne sont pas les m√™mes¬†; ou</p>
</li>
<li class="data-line-326">
<p>l&#8217;√©l√©ment sup√©rieur de la pile est sup√©rieur au champ <code>nLocktime</code> de la transaction¬†; ou</p>
</li>
<li class="data-line-327">
<p>le champ <code>nSequence</code> de l&#8217;entr√©e est 0xffffffff.</p>
</li>
</ol>
</div>
<div class="admonitionblock note data-line-330">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-331">
<p>CLTV et <code>nLocktime</code> utilisent le m√™me format pour d√©crire les verrous temporels, soit une hauteur de bloc, soit le temps √©coul√© en secondes depuis l&#8217;√©poque Unix. De mani√®re critique, lorsqu&#8217;ils sont utilis√©s ensemble, le format de <code>nLocktime</code> doit correspondre √† celui de <code>CLTV</code> dans les sorties - ils doivent tous deux r√©f√©rencer soit la hauteur de bloc, soit le temps en secondes.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-334">
<p>Apr√®s l&#8217;ex√©cution, si <code>CLTV</code> est satisfait, le param√®tre de temps qui l&#8217;a pr√©c√©d√© reste l&#8217;√©l√©ment sup√©rieur de la pile et peut devoir √™tre supprim√©, avec DROP, pour une ex√©cution correcte des opcodes de script suivants. Vous verrez souvent <code>CHECKLOCKTIMEVERIFY</code> suivi de <code>DROP</code> dans les scripts pour cette raison.</p>
</div>
<div class="paragraph data-line-336">
<p>En utilisant <code>nLocktime</code> conjointement avec CLTV, le sc√©nario d√©crit dans <a href="#locktime_limitations">Limitations du temps de verrouillage des transactions</a> changements. Alice ne peut plus d√©penser l&#8217;argent (car il est verrouill√© avec la cl√© de Bob) et Bob ne peut pas le d√©penser avant l&#8217;expiration du temps de verrouillage de 3 mois.</p>
</div>
<div class="paragraph data-line-338">
<p>En introduisant la fonctionnalit√© timelock directement dans le langage de script, <code>CLTV</code> nous permet de d√©velopper des scripts complexes tr√®s int√©ressants.</p>
</div>
<div class="paragraph data-line-340">
<p>La norme est d√©finie dans <a href="https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki">BIP-65 (CHECKLOCKTIMEVERIFY)</a>.</p>
</div>
</div>
<div class="sect3 data-line-342">
<h4 id="_verrous_temporels_relatifs">Verrous temporels relatifs</h4>
<div class="paragraph data-line-344">
<p>nLocktime et <code>CLTV</code> sont les deux <em>verrous temporels absolus</em> en ce sens qu&#8217;ils sp√©cifient un point absolu dans le temps. Les deux prochaines fonctionnalit√©s de verrou temporel que nous examinerons sont des <em>verrous temporels relatifs</em> en ce sens qu&#8217;elles sp√©cifient, comme condition de d√©pense d&#8217;une sortie, un temps √©coul√© depuis la confirmation de la sortie dans la cha√Æne de blocs.</p>
</div>
<div class="paragraph data-line-346">
<p>Les verrous temporels relatifs sont utiles car ils permettent de bloquer une cha√Æne de deux transactions interd√©pendantes ou plus, tout en imposant une contrainte de temps sur une transaction qui d√©pend du temps √©coul√© depuis la confirmation d&#8217;une transaction pr√©c√©dente. En d&#8217;autres termes, l&#8217;horloge ne commence pas √† compter tant que l&#8217;UTXO n&#8217;est pas enregistr√© sur la cha√Æne de blocs. Cette fonctionnalit√© est particuli√®rement utile dans les canaux d&#8217;√©tat bidirectionnels et les r√©seaux Lightning, comme nous le verrons dans <a href="#state_channels">[state_channels]</a>.</p>
</div>
<div class="paragraph data-line-348">
<p>Les verrous temporels relatifs, comme les verrous temporels absolus, sont impl√©ment√©s √† la fois avec une fonctionnalit√© au niveau de la transaction et un opcode au niveau du script. Le verrouillage temporel relatif au niveau de la transaction est impl√©ment√© comme une r√®gle de consensus sur la valeur de nSequence, un champ de transaction qui est d√©fini dans chaque entr√©e de transaction. Les verrous temporels relatifs au niveau du script sont impl√©ment√©s avec l&#8217;opcode <code>CHECKSEQUENCEVERIFY</code> (CSV).</p>
</div>
<div class="paragraph data-line-350">
<p>Les verrous temporels relatifs sont impl√©ment√©s conform√©ment aux sp√©cifications de <a href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki">BIP-68, Relative lock-time using consensus-enforced sequence numbers</a> et <a href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki">BIP-112, CHECKSEQUENCEVERIFY</a>.</p>
</div>
<div class="paragraph data-line-352">
<p>BIP-68 et BIP-112 ont √©t√© activ√©s en mai 2016 en tant que mise √† niveau soft fork des r√®gles de consensus.</p>
</div>
</div>
<div class="sect3 data-line-354">
<h4 id="_verrous_temporels_relatifs_avec_nsequence">Verrous temporels relatifs avec nSequence</h4>
<div class="paragraph data-line-356">
<p>Des verrous temporels relatifs peuvent √™tre d√©finis sur chaque entr√©e d&#8217;une transaction, en d√©finissant le champ <code>nSequence</code> dans chaque contribution.</p>
</div>
<div class="sect4 data-line-358">
<h5 id="_signification_originale_de_nsequence">Signification originale de nSequence</h5>
<div class="paragraph data-line-360">
<p>Le champ <code>nSequence</code> √©tait √† l&#8217;origine destin√© (mais jamais correctement impl√©ment√©) √† permettre la modification des transactions dans le mempool. Dans cette utilisation, une transaction contenant des entr√©es avec une valeur <code>nSequence</code> inf√©rieure √† 2<sup>32</sup> - 1 (0xFFFFFFFF) indiquait une transaction qui n&#8217;√©tait pas encore "finalis√©e". Une telle transaction serait conserv√©e dans le mempool jusqu&#8217;√† ce qu&#8217;elle soit remplac√©e par une autre transaction d√©pensant les m√™mes entr√©es avec une valeur <code>nSequence</code> plus √©lev√©e. Une fois qu&#8217;une transaction a √©t√© re√ßue dont les entr√©es avaient une valeur <code>nSequence</code> de 0xFFFFFFFF, elle serait consid√©r√©e comme "finalis√©e" et min√©e.</p>
</div>
<div class="paragraph data-line-362">
<p>La signification originale de <code>nSequence</code> n&#8217;a jamais √©t√© correctement impl√©ment√©e et la valeur de <code>nSequence</code> est habituellement d√©finie sur 0xFFFFFFFF dans les transactions qui n&#8217;utilisent pas de verrous temporels. Pour les transactions avec <code>nLocktime</code> ou CHECKLOCKTIMEVERIFY, la valeur <code>nSequence</code> doit √™tre inf√©rieure √† 2<sup>31</sup> pour que les gardes de verrou temporel aient un effet, comme expliqu√© ci-dessous.</p>
</div>
</div>
<div class="sect4 data-line-364">
<h5 id="_nsequence_comme_un_verrou_temporel_relatif_impos√©_par_consensus">nSequence comme un verrou temporel relatif impos√© par consensus</h5>
<div class="paragraph data-line-366">
<p>Depuis l&#8217;activation de BIP-68, de nouvelles r√®gles de consensus s&#8217;appliquent pour toute transaction contenant une entr√©e dont la valeur <code>nSequence</code> est inf√©rieure √† 2<sup>31</sup> (le bit 1&lt;&lt;31 n&#8217;est pas d√©fini). Par programmation, cela signifie que si le bit le plus significatif (bit 1&lt;&lt;31) n&#8217;est pas d√©fini, c&#8217;est un indicateur qui signifie "temps de verrouillage relatif". Sinon (bit 1&lt;&lt;31 d√©fini), la valeur <code>nSequence</code> est r√©serv√©e √† d&#8217;autres utilisations telles que l&#8217;activation de CHECKLOCKTIMEVERIFY, nLocktime, Opt-In-Replace-By-Fee et d&#8217;autres d√©veloppements futurs.</p>
</div>
<div class="paragraph data-line-368">
<p>Les entr√©es de transaction avec des valeurs <code>nSequence</code> inf√©rieures √† 2<sup>31</sup> sont interpr√©t√©es comme ayant un verrou temporel relatif. Une telle transaction n&#8217;est valide qu&#8217;une fois que l&#8217;entr√©e a vieilli du montant relatif du verrou temporel. Par exemple, une transaction avec une entr√©e et un verrou temporel relatif <code>nSequence</code> de 30 blocs n&#8217;est valide que lorsqu&#8217;au moins 30 blocs se sont √©coul√©s depuis le moment o√π l&#8217;UTXO r√©f√©renc√© dans l&#8217;entr√©e a √©t√© extrait. √âtant donn√© que <code>nSequence</code> est un champ par entr√©e, une transaction peut contenir n&#8217;importe quel nombre d&#8217;entr√©es verrouill√©es dans le temps, qui doivent toutes avoir suffisamment vieilli pour que la transaction soit valide. Une transaction peut inclure √† la fois des entr√©es √† verrouillage temporel (nSequence &lt; 2<sup>31</sup>) et des entr√©es sans verrouillage temporel relatif (nSequence &gt;= 2<sup>31</sup>).</p>
</div>
<div class="paragraph data-line-370">
<p>La valeur <code>nSequence</code> est sp√©cifi√©e en blocs ou en secondes, mais dans un format l√©g√®rement diff√©rent de celui que nous avons vu utilis√© dans nLocktime. Un indicateur de type est utilis√© pour diff√©rencier les valeurs comptant les blocs et les valeurs comptant le temps en secondes. Le drapeau de type est d√©fini dans le 23e bit le moins significatif (c&#8217;est-√†-dire la valeur 1&lt;&lt;22). Si le type-flag est d√©fini, alors la valeur <code>nSequence</code> est interpr√©t√©e comme un multiple de 512 secondes. Si le drapeau de type n&#8217;est pas d√©fini, la valeur <code>nSequence</code> est interpr√©t√©e comme un nombre de blocs.</p>
</div>
<div class="paragraph data-line-372">
<p>Lors de l&#8217;interpr√©tation de <code>nSequence</code> comme un timelock relatif, seuls les 16 bits les moins significatifs sont pris en compte. Une fois que les drapeaux (bits 32 et 23) sont √©valu√©s, la valeur <code>nSequence</code> est g√©n√©ralement "masqu√©e" avec un masque de 16 bits (par exemple, <code>nSequence</code> &amp; 0x0000FFFF).</p>
</div>
<div class="paragraph data-line-374">
<p><a href="#bip_68_def_of_nseq">D√©finition BIP-68 du codage nSequence (Source¬†: BIP-68)</a> montre la disposition binaire de la valeur nSequence, telle que d√©finie par BIP-68.</p>
</div>
<div id="bip_68_def_of_nseq" class="imageblock data-line-378">
<div class="content">
<img src="images/mbc2_0701.png" alt="D√©finition BIP-68 du codage nSequence">
</div>
<div class="title">Figure 1. D√©finition BIP-68 du codage nSequence (Source¬†: BIP-68)</div>
</div>
<div class="paragraph data-line-381">
<p>Les verrous temporels relatifs bas√©s sur l&#8217;application consensuelle de la valeur <code>nSequence</code> sont d√©finis dans BIP-68.</p>
</div>
<div class="paragraph data-line-383">
<p>La norme est d√©finie dans <a href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki">BIP-68, Relative lock-time using consensus-enforced sequence numbers</a>.</p>
</div>
</div>
</div>
<div class="sect3 data-line-385">
<h4 id="_verrous_temporels_relatifs_avec_csv">Verrous temporels relatifs avec CSV</h4>
<div class="paragraph data-line-387">
<p>Tout comme CLTV et nLocktime, il existe un opcode de script pour les verrous temporels relatifs qui exploite le Valeur <code>nSequence</code> dans les scripts. Cet opcode est CHECKSEQUENCEVERIFY, commun√©ment appel√© <code>CSV</code> en abr√©g√©.</p>
</div>
<div class="paragraph data-line-389">
<p>L&#8217;opcode CSV, lorsqu&#8217;il est √©valu√© dans le script de remboursement d&#8217;un UTXO, permet de d√©penser uniquement dans une transaction dont la valeur d&#8217;entr√©e <code>nSequence</code> est sup√©rieure ou √©gale au param√®tre CSV. Essentiellement, cela limite la d√©pense de l&#8217;UTXO jusqu&#8217;√† ce qu&#8217;un certain nombre de blocs ou de secondes se soient √©coul√©s par rapport au moment o√π l&#8217;UTXO a √©t√© min√©.</p>
</div>
<div class="paragraph data-line-391">
<p>Comme pour CLTV, la valeur dans <code>CSV</code> doit correspondre au format de la valeur <code>nSequence</code> correspondante. Si <code>CSV</code> est sp√©cifi√© en termes de blocs, il doit en √™tre de m√™me pour nSequence. Si <code>CSV</code> est sp√©cifi√© en termes de secondes, alors <code>nSequence</code> doit √©galement l&#8217;√™tre.</p>
</div>
<div class="paragraph data-line-393">
<p>Les timelocks relatifs avec <code>CSV</code> sont particuli√®rement utiles lorsque plusieurs transactions (cha√Æn√©es) sont cr√©√©es et sign√©es, mais non propag√©es, lorsqu&#8217;elles sont conserv√©es "hors cha√Æne". Une transaction enfant ne peut pas √™tre utilis√©e tant que la transaction parent n&#8217;a pas √©t√© propag√©e, extraite et vieillie au moment sp√©cifi√© dans le timelock relatif. Une application de ce cas d&#8217;utilisation peut √™tre vue dans <a href="#state_channels">[state_channels]</a> et <a href="#lightning_network">[lightning_network]</a>.</p>
</div>
<div class="paragraph data-line-395">
<p>CSV est d√©fini en d√©tail dans <a href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki">BIP-112, CHECKSEQUENCEVERIFY</a>.</p>
</div>
</div>
<div class="sect3 data-line-398">
<h4 id="_temps_m√©dian_pass√©">Temps m√©dian pass√©</h4>
<div class="paragraph data-line-400">
<p>Dans le cadre de l&#8217;activation des verrous temporels relatifs, il y a √©galement eu un changement dans la fa√ßon dont le "temps" est calcul√© pour les verrous temporels (√† la fois absolus et relatifs). Dans le bitcoin, il existe une diff√©rence subtile, mais tr√®s significative, entre le temps du mur et le temps du consensus. Bitcoin est un r√©seau d√©centralis√©, ce qui signifie que chaque participant a sa propre vision du temps. Les √©v√©nements sur le r√©seau ne se produisent pas instantan√©ment partout. La latence du r√©seau doit √™tre prise en compte dans la perspective de chaque n≈ìud. Finalement, tout est synchronis√© pour cr√©er un grand livre commun. Bitcoin atteint un consensus toutes les 10 minutes sur l&#8217;√©tat du grand livre tel qu&#8217;il existait dans le pass√©.</p>
</div>
<div class="paragraph data-line-402">
<p>Les horodatages d√©finis dans les en-t√™tes de bloc sont d√©finis par les mineurs. Il existe un certain degr√© de latitude autoris√© par les r√®gles de consensus pour tenir compte des diff√©rences de pr√©cision d&#8217;horloge entre les n≈ìuds d√©centralis√©s. Cependant, cela cr√©e une incitation malheureuse pour les mineurs √† mentir sur le temps pass√© dans un bloc afin de gagner des frais suppl√©mentaires en incluant des transactions verrouill√©es dans le temps qui ne sont pas encore matures. Voir la section suivante pour plus d&#8217;informations.</p>
</div>
<div class="paragraph data-line-404">
<p>Pour supprimer l&#8217;incitation au mensonge et renforcer la s√©curit√© des verrous temporels, un BIP a √©t√© propos√© et activ√© en m√™me temps que les BIP des verrous temporels relatifs. Il s&#8217;agit de BIP-113, qui d√©finit une nouvelle mesure consensuelle du temps appel√©e <em>Median-Time-Past</em> (temps-m√©dian-pass√©).</p>
</div>
<div class="paragraph data-line-406">
<p>Le Median-Time-Past est calcul√© en prenant les horodatages des 11 derniers blocs et en trouvant la m√©diane. Ce temps m√©dian devient alors le temps de consensus et est utilis√© pour tous les calculs de verrou temporel. En prenant le point m√©dian d&#8217;environ deux heures dans le pass√©, l&#8217;influence de l&#8217;horodatage de n&#8217;importe quel bloc est r√©duite. En incorporant 11 blocs, aucun mineur ne peut influencer les horodatages afin de gagner des frais sur les transactions avec un verrou temporel qui n&#8217;est pas encore arriv√© √† √©ch√©ance.</p>
</div>
<div class="paragraph data-line-408">
<p>Median-Time-Past modifie l&#8217;impl√©mentation des calculs de temps pour nLocktime, CLTV, <code>nSequence</code> et CSV. L&#8217;heure de consensus calcul√©e par Median-Time-Past est toujours d&#8217;environ une heure en retard sur l&#8217;heure de l&#8217;horloge murale. Si vous cr√©ez des transactions avec verrou temporel, vous devez en tenir compte lors de l&#8217;estimation de la valeur souhait√©e √† encoder dans nLocktime, nSequence, <code>CLTV</code> et CSV.</p>
</div>
<div class="paragraph data-line-410">
<p>Median-Time-Past est sp√©cifi√© dans <a href="https://github.com/bitcoin/bips/blob/master/bip-0113.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0113.mediawiki">BIP-113</a>.</p>
</div>
</div>
<div class="sect3 data-line-413">
<h4 id="fee_sniping">D√©fense contre le "sniping" avec un verrou temporel</h4>
<div class="paragraph data-line-415">
<p>Le "sniping" ou le "ciblage" est un sc√©nario d&#8217;attaque th√©orique, o√π les mineurs tentant de r√©√©crire des blocs pass√©s "snipe" ou "en ciblant" des frais plus √©lev√©s transactions des futurs blocs pour maximiser leur rentabilit√©.</p>
</div>
<div class="paragraph data-line-417">
<p>Par exemple, disons que le bloc le plus √©lev√© existant est le bloc #100 000. Si au lieu d&#8217;essayer d&#8217;exploiter le bloc #100 001 pour √©tendre la cha√Æne, certains mineurs tentent de r√©exploiter #100 000. Ces mineurs peuvent choisir d&#8217;inclure toute transaction valide (qui n&#8217;a pas encore √©t√© exploit√©e) dans leur bloc candidat #100 000. Ils n&#8217;ont pas √† reminer le bloc avec les m√™mes transactions. En fait, ils sont incit√©s √† s√©lectionner les transactions les plus rentables (frais les plus √©lev√©s par Ko) √† inclure dans leur bloc. Ils peuvent inclure toutes les transactions qui se trouvaient dans "l&#8217;ancien" bloc #100 000, ainsi que toutes les transactions du mempool actuel. Essentiellement, ils ont la possibilit√© d&#8217;extraire des transactions du "pr√©sent" vers le "pass√©" r√©√©crit lorsqu&#8217;ils recr√©ent le bloc #100 000.</p>
</div>
<div class="paragraph data-line-419">
<p>Aujourd&#8217;hui, cette attaque n&#8217;est pas tr√®s lucrative, car la r√©compense de bloc est bien sup√©rieure au total des frais par bloc. Mais √† un moment donn√© dans le futur, les frais de transaction repr√©senteront la majorit√© de la r√©compense mini√®re (ou m√™me l&#8217;int√©gralit√© de la r√©compense mini√®re). A ce moment-l√†, ce sc√©nario devient in√©vitable.</p>
</div>
<div class="paragraph data-line-421">
<p>Pour √©viter le "ciblage de frais", lorsque Bitcoin Core cr√©e des transactions, il utilise <code>nLocktime</code> pour les limiter au "bloc suivant", par d√©faut. Dans notre sc√©nario, Bitcoin Core d√©finirait <code>nLocktime</code> sur 100 001 sur toute transaction cr√©√©e. Dans des circonstances normales, ce <code>nLocktime</code> n&#8217;a aucun effet - les transactions ne peuvent √™tre incluses que dans le bloc #100 001 de toute fa√ßon¬†; c&#8217;est le bloc suivant.</p>
</div>
<div class="paragraph data-line-423">
<p>Mais dans le cadre d&#8217;une attaque enfourchement de la cha√Æne de blocs/double d√©pense, les mineurs ne seraient pas en mesure d&#8217;extraire des transactions √† frais √©lev√©s du mempool, car toutes ces transactions seraient bloqu√©es dans le temps pour bloquer #100 001. Ils ne peuvent reminer que #100 000 avec les transactions valides √† ce moment-l√†, ne gagnant essentiellement aucun nouveau frais.</p>
</div>
<div class="paragraph data-line-425">
<p>Pour ce faire, Bitcoin Core d√©finit le <code>nLocktime</code> sur toutes les nouvelles transactions √† &lt;current block # + 1&gt; et d√©finit la <code>nSequence</code> sur toutes les entr√©es √† 0xFFFFFFFE pour activer nLocktime.</p>
</div>
</div>
</div>
<div class="sect2 data-line-427">
<h3 id="_scripts_avec_contr√¥le_de_flux_clauses_conditionnelles">Scripts avec contr√¥le de flux (clauses conditionnelles)</h3>
<div class="paragraph data-line-429">
<p>L&#8217;une des fonctionnalit√©s les plus puissantes de Bitcoin Script est le contr√¥le de flux, √©galement connu sous le nom de clauses conditionnelles. Vous √™tes probablement familiaris√© avec le contr√¥le de flux dans divers langages de programmation qui utilisent la construction IF...THEN...ELSE. Les clauses conditionnelles Bitcoin semblent un peu diff√©rentes, mais sont essentiellement la m√™me construction.</p>
</div>
<div class="paragraph data-line-431">
<p>√Ä un niveau de base, les opcodes conditionnels bitcoin nous permettent de construire un script de rachat qui a deux fa√ßons d&#8217;√™tre d√©verrouill√©, en fonction d&#8217;un r√©sultat TRUE/FALSE d&#8217;√©valuation d&#8217;une condition logique. Par exemple, si x est TRUE, le script de rachat est A et le script de rachat ELSE est B.</p>
</div>
<div class="paragraph data-line-433">
<p>De plus, les expressions conditionnelles Bitcoin peuvent √™tre "imbriqu√©es" ind√©finiment, ce qui signifie qu&#8217;une clause conditionnelle peut en contenir une autre, qui en contient une autre, etc. Le contr√¥le de flux Bitcoin Script peut √™tre utilis√© pour construire des scripts tr√®s complexes avec des centaines voire des milliers de chemins d&#8217;ex√©cution possibles. Il n&#8217;y a pas de limite √† l&#8217;imbrication, mais les r√®gles de consensus imposent une limite √† la taille maximale, en octets, d&#8217;un script.</p>
</div>
<div class="paragraph data-line-435">
<p>Bitcoin impl√©mente le contr√¥le de flux √† l&#8217;aide des opcodes IF, ELSE, <code>ENDIF</code> et NOTIF. De plus, les expressions conditionnelles peuvent contenir des op√©rateurs bool√©ens tels que BOOLAND, <code>BOOLOR</code> et NOT.</p>
</div>
<div class="paragraph data-line-437">
<p>√Ä premi√®re vue, vous pouvez trouver les scripts de contr√¥le de flux du bitcoin d√©routants. En effet, Bitcoin Script est un langage de pile. De la m√™me mani√®re que <code>1 &#43; 1</code> semble "renvers√©" lorsqu&#8217;il est exprim√© comme 1 1 ADD, les clauses de contr√¥le de flux dans bitcoin semblent √©galement "renvers√©s".</p>
</div>
<div class="paragraph data-line-439">
<p>Dans la plupart des langages de programmation traditionnels (proc√©duraux), le contr√¥le de flux ressemble √† ceci¬†:</p>
</div>
<div class="listingblock data-line-442">
<div class="title">Pseudocode de contr√¥le de flux dans la plupart des langages de programmation</div>
<div class="content">
<pre>si (condition):
  code √† ex√©cuter lorsque la condition est vraie
autre:
  code √† ex√©cuter lorsque la condition est fausse
code √† ex√©cuter dans les deux cas</pre>
</div>
</div>
<div class="paragraph data-line-450">
<p>Dans un langage bas√© sur la pile comme Bitcoin Script, la condition logique vient avant le IF, ce qui le fait appara√Ætre "en arri√®re", comme ceci¬†:</p>
</div>
<div class="listingblock data-line-453">
<div class="title">Contr√¥le de flux Bitcoin Script</div>
<div class="content">
<pre>condition
IF
  code √† ex√©cuter lorsque la condition est vraie
ELSE
  code √† ex√©cuter lorsque la condition est fausse
ENDIF
code √† ex√©cuter dans les deux cas</pre>
</div>
</div>
<div class="paragraph data-line-463">
<p>Lors de la lecture du script Bitcoin, rappelez-vous que la condition √©valu√©e vient <em>avant</em> l&#8217;opcode IF.</p>
</div>
<div class="sect3 data-line-465">
<h4 id="_clauses_conditionnelles_avec_les_opcodes_verify">Clauses conditionnelles avec les opcodes VERIFY</h4>
<div class="paragraph data-line-467">
<p>Une autre forme de conditionnel dans Bitcoin Script est tout opcode qui se termine par VERIFY. Le suffixe <code>VERIFY</code> signifie que si la condition √©valu√©e n&#8217;est pas TRUE, l&#8217;ex√©cution du script se termine imm√©diatement et la transaction est consid√©r√©e comme invalide.</p>
</div>
<div class="paragraph data-line-469">
<p>Contrairement √† une clause IF, qui offre des chemins d&#8217;ex√©cution alternatifs, le suffixe <code>VERIFY</code> agit comme une <em>clause de garde</em>, ne continuant que si une condition pr√©alable est remplie.</p>
</div>
<div class="paragraph data-line-471">
<p>Par exemple, le script suivant n√©cessite la signature de Bob et une pr√©-image (secret) qui produit un hachage sp√©cifique. Les deux conditions doivent √™tre remplies pour le d√©verrouiller :</p>
</div>
<div class="listingblock data-line-474">
<div class="title">Un script de rachat avec une clause de garde EQUALVERIFY.</div>
<div class="content">
<pre>HASH160 &lt;expected hash&gt; EQUALVERIFY &lt;Bob's Pubkey&gt; CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-478">
<p>Pour racheter cela, Bob doit construire un script de d√©verrouillage qui pr√©sente une pr√©-image valide et une signature¬†:</p>
</div>
<div class="listingblock data-line-481">
<div class="title">Un script de d√©verrouillage pour satisfaire le script de rachat ci-dessus</div>
<div class="content">
<pre>&lt;Bob's Sig&gt; &lt;hash pre-image&gt;</pre>
</div>
</div>
<div class="paragraph data-line-485">
<p>Sans pr√©senter la pr√©-image, Bob ne peut pas acc√©der √† la partie du script qui v√©rifie sa signature.</p>
</div>
<div class="paragraph pagebreak-after data-line-488">
<p>Ce script peut √™tre √©crit avec un <code>IF</code> √† la place¬†:</p>
</div>
<div class="listingblock data-line-491">
<div class="title">Un script de rachat avec une clause de garde IF</div>
<div class="content">
<pre>HASH160 &lt;expected hash&gt; EQUAL
IF
   &lt;Bob's Pubkey&gt; CHECKSIG
ENDIF</pre>
</div>
</div>
<div class="paragraph data-line-498">
<p>Le script de d√©verrouillage de Bob est identique¬†:</p>
</div>
<div class="listingblock data-line-501">
<div class="title">Un script de d√©verrouillage pour satisfaire le script de rachat ci-dessus</div>
<div class="content">
<pre>&lt;Bob's Sig&gt; &lt;hash pre-image&gt;</pre>
</div>
</div>
<div class="paragraph data-line-505">
<p>Le script avec <code>IF</code> fait la m√™me chose que d&#8217;utiliser un opcode avec un suffixe <code>VERIFY</code> ; elles fonctionnent toutes deux comme des clauses de garde. Cependant, la construction <code>VERIFY</code> est plus efficace, utilisant deux opcodes de moins.</p>
</div>
<div class="paragraph data-line-507">
<p>Alors, quand utilisons-nous <code>VERIFY</code> et quand utilisons-nous IF¬†? Si tout ce que nous essayons de faire est d&#8217;attacher une condition pr√©alable (clause de garde), alors <code>VERIFY</code> est pr√©f√©rable. Si, toutefois, nous voulons avoir plus d&#8217;un chemin d&#8217;ex√©cution (contr√¥le de flux), nous avons besoin d&#8217;une clause de contr√¥le de flux IF...ELSE.</p>
</div>
<div class="admonitionblock tip data-line-510">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-511">
<p>Un opcode tel que <code>EQUAL</code> poussera le r√©sultat (TRUE/FALSE) sur la pile, le laissant l√† pour √©valuation par les opcodes suivants. En revanche, le suffixe de l&#8217;opcode <code>EQUALVERIFY</code> ne laisse rien sur la pile. Les opcodes qui se terminent par <code>VERIFY</code> ne laissent pas le r√©sultat sur la pile.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-514">
<h4 id="_utilisation_du_contr√¥le_de_flux_dans_les_scripts">Utilisation du contr√¥le de flux dans les scripts</h4>
<div class="paragraph data-line-516">
<p>Une utilisation tr√®s courante du contr√¥le de flux dans Bitcoin Script consiste √† construire un script de rachat qui offre plusieurs chemins d&#8217;ex√©cution, chacun une mani√®re diff√©rente de racheter l&#8217;UTXO.</p>
</div>
<div class="paragraph data-line-518">
<p>Regardons un exemple simple, o√π nous avons deux signataires, Alice et Bob, et l&#8217;un ou l&#8217;autre est en mesure de racheter. Avec multisig, cela serait exprim√© sous la forme d&#8217;un script multisig 1 sur 2. Pour des raisons de d√©monstration, nous ferons la m√™me chose avec une clause IF¬†:</p>
</div>
<div class="listingblock data-line-520">
<div class="content">
<pre>IF
 &lt;Alice's Pubkey&gt; CHECKSIG
ELSE
 &lt;Bob's Pubkey&gt; CHECKSIG
ENDIF</pre>
</div>
</div>
<div class="paragraph data-line-528">
<p>En regardant ce script de rachat, vous vous demandez peut-√™tre¬†: "O√π est la condition ? Il n&#8217;y a rien qui pr√©c√®de la clause <code>IF</code> !"</p>
</div>
<div class="paragraph data-line-530">
<p>La condition ne fait pas partie du script de rachat. Au lieu de cela, la condition sera propos√©e dans le script de d√©verrouillage, permettant √† Alice et Bob de "choisir" le chemin d&#8217;ex√©cution qu&#8217;ils souhaitent.</p>
</div>
<div class="paragraph data-line-532">
<p>Alice rach√®te cela avec le script de d√©verrouillage¬†:</p>
</div>
<div class="listingblock data-line-533">
<div class="content">
<pre>&lt;Alice's Sig&gt; 1</pre>
</div>
</div>
<div class="paragraph data-line-537">
<p>Le <code>1</code> √† la fin sert de condition (TRUE) qui fera que la clause <code>IF</code> ex√©cutera le premier chemin de rachat pour lequel Alice a une signature.</p>
</div>
<div class="paragraph data-line-539">
<p>Pour que Bob puisse racheter cela, il devrait choisir le deuxi√®me chemin d&#8217;ex√©cution en donnant une valeur <code>FALSE</code> √† la clause IF¬†:</p>
</div>
<div class="listingblock data-line-541">
<div class="content">
<pre>&lt;Bob's Sig&gt; 0</pre>
</div>
</div>
<div class="paragraph data-line-545">
<p>Le script de d√©verrouillage de Bob place un <code>0</code> sur la pile, ce qui oblige la clause <code>IF</code> √† ex√©cuter le deuxi√®me script (ELSE), qui n√©cessite la signature de Bob.</p>
</div>
<div class="paragraph data-line-547">
<p>Puisque les clauses <code>IF</code> peuvent √™tre imbriqu√©es, nous pouvons cr√©er un "labyrinthe" de chemins d&#8217;ex√©cution. Le script de d√©verrouillage peut fournir une "carte" s√©lectionnant le chemin d&#8217;ex√©cution r√©ellement ex√©cut√©¬†:</p>
</div>
<div class="listingblock data-line-549">
<div class="content">
<pre>IF
  script A
ELSE
  IF
    script B
  ELSE
    script C
  ENDIF
ENDIF</pre>
</div>
</div>
<div class="paragraph data-line-561">
<p>Dans ce sc√©nario, il existe trois chemins d&#8217;ex√©cution (script A, <code>script B</code> et script C). Le script de d√©verrouillage fournit un chemin sous la forme d&#8217;une s√©quence de valeurs <code>TRUE</code> ou FALSE. Pour s√©lectionner le chemin script B, par exemple, le script de d√©verrouillage doit se terminer par <code>1 0</code> (TRUE, FALSE). Ces valeurs seront pouss√©es sur la pile, de sorte que la deuxi√®me valeur (FALSE) se retrouve en haut de la pile. La clause <code>IF</code> externe extrait la valeur <code>FALSE</code> et ex√©cute la premi√®re clause ELSE. Ensuite, la valeur <code>TRUE</code> se d√©place vers le haut de la pile et est √©valu√©e par le <code>IF</code> interne (imbriqu√©), en s√©lectionnant le chemin d&#8217;ex√©cution B.</p>
</div>
<div class="paragraph data-line-563">
<p>En utilisant cette construction, nous pouvons cr√©er des scripts de rachat avec des dizaines ou des centaines de chemins d&#8217;ex√©cution, chacun offrant une mani√®re diff√©rente de racheter l&#8217;UTXO. Pour d√©penser, nous construisons un script de d√©verrouillage qui navigue dans le chemin d&#8217;ex√©cution en pla√ßant les valeurs <code>TRUE</code> et <code>FALSE</code> appropri√©es sur la pile √† chaque point de contr√¥le de flux.</p>
</div>
</div>
</div>
<div class="sect2 data-line-565">
<h3 id="_exemple_de_script_complexe">Exemple de script complexe</h3>
<div class="paragraph data-line-567">
<p>Dans cette section, nous combinons de nombreux concepts de ce chapitre en un seul exemple.</p>
</div>
<div class="paragraph data-line-569">
<p>Notre exemple utilise l&#8217;histoire de Mohammed, le propri√©taire d&#8217;une entreprise √† Duba√Ø qui exploite une entreprise d&#8217;import/export.</p>
</div>
<div class="paragraph data-line-571">
<p>Dans cet exemple, Mohammed souhaite construire un compte de capital d&#8217;entreprise avec des r√®gles flexibles. Le sch√©ma qu&#8217;il cr√©e n√©cessite diff√©rents niveaux d&#8217;autorisation en fonction des verrous temporels. Les participants au programme multisig sont Mohammed, ses deux partenaires Saeed et Zaira, et leur avocat Abdul. Les trois partenaires prennent des d√©cisions bas√©es sur une r√®gle de majorit√©, donc deux des trois doivent √™tre d&#8217;accord. Cependant, en cas de probl√®me avec leurs cl√©s, ils souhaitent que leur avocat puisse r√©cup√©rer les fonds avec l&#8217;une des trois signatures d&#8217;associ√©s. Enfin, si tous les associ√©s sont indisponibles ou inaptes pendant un certain temps, ils souhaitent que l&#8217;avocat puisse g√©rer directement le compte.</p>
</div>
<div class="paragraph data-line-573">
<p>Voici le script de rachat que Mohammed con√ßoit pour y parvenir (pr√©fixe de num√©ro de ligne en tant que XX)¬†:</p>
</div>
<div class="listingblock data-line-576">
<div class="title">Variable Multi-Signature avec verrou temporel</div>
<div class="content">
<pre>01  IF
02    IF
03      2
04    ELSE
05      &lt;30 days&gt; CHECKSEQUENCEVERIFY DROP
06      &lt;Abdul the Lawyer's Pubkey&gt; CHECKSIGVERIFY
07      1
08    ENDIF
09    &lt;Mohammed's Pubkey&gt; &lt;Saeed's Pubkey&gt; &lt;Zaira's Pubkey&gt; 3 CHECKMULTISIG
10  ELSE
11    &lt;90 days&gt; CHECKSEQUENCEVERIFY DROP
12    &lt;Abdul the Lawyer's Pubkey&gt; CHECKSIG
13  ENDIF</pre>
</div>
</div>
<div class="paragraph data-line-592">
<p>Le script de Mohammed impl√©mente trois chemins d&#8217;ex√©cution √† l&#8217;aide de clauses de contr√¥le de flux imbriqu√©es IF...ELSE.</p>
</div>
<div class="paragraph data-line-594">
<p>Dans le premier chemin d&#8217;ex√©cution, ce script fonctionne comme un simple multisig 2 sur 3 avec les trois partenaires. Ce chemin d&#8217;ex√©cution se compose des lignes 3 et 9. La ligne 3 d√©finit le quorum du multisig √† <code>2</code> (2-de-3). Ce chemin d&#8217;ex√©cution peut √™tre s√©lectionn√© en mettant <code>TRUE TRUE</code> √† la fin du script de d√©verrouillage¬†:</p>
</div>
<div class="listingblock data-line-597">
<div class="title">Script de d√©verrouillage pour le premier chemin d&#8217;ex√©cution (2-de-3 multisig)</div>
<div class="content">
<pre>0 &lt;Mohammed's Sig&gt; &lt;Zaira's Sig&gt; TRUE TRUE</pre>
</div>
</div>
<div class="admonitionblock tip data-line-603">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-604">
<p>Le <code>0</code> au d√©but de ce script de d√©verrouillage est d√ª √† un bogue dans <code>CHECKMULTISIG</code> qui extrait une valeur suppl√©mentaire de la pile. La valeur suppl√©mentaire est ignor√©e par le CHECKMULTISIG, mais elle doit √™tre pr√©sente ou le script √©choue. Pousser <code>0</code> (habituellement) est une solution de contournement au bogue, comme d√©crit dans <a href="#multisig_bug">Un bogue dans l&#8217;ex√©cution de CHECKMULTISIG</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-607">
<p>Le deuxi√®me chemin d&#8217;ex√©cution ne peut √™tre utilis√© qu&#8217;apr√®s 30 jours √† compter de la cr√©ation de l&#8217;UTXO. √Ä ce moment-l√†, il faut la signature d&#8217;Abdul l&#8217;avocat et de l&#8217;un des trois partenaires (un multisig 1 sur 3). Ceci est r√©alis√© par la ligne 7, qui fixe le quorum pour le multisig √† 1. Pour s√©lectionner ce chemin d&#8217;ex√©cution, le script de d√©verrouillage se terminerait par FALSE TRUE¬†:</p>
</div>
<div class="listingblock data-line-610">
<div class="title">Script de d√©verrouillage pour le deuxi√®me chemin d&#8217;ex√©cution (Avocat + 1 sur 3)</div>
<div class="content">
<pre>0 &lt;Abdul the Lawyer's Sig&gt; &lt;Saeed's Sig&gt; FALSE TRUE</pre>
</div>
</div>
<div class="admonitionblock tip data-line-615">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-616">
<p>Pourquoi FAUX VRAI¬†? N&#8217;est-ce pas √† l&#8217;envers ? Parce que les deux valeurs sont pouss√©es sur la pile, avec <code>FALSE</code> pouss√© en premier, puis <code>TRUE</code> pouss√© en second. <code>TRUE</code> est donc d√©pil√© <em>premier</em> par le premier opcode IF.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-619">
<p>Enfin, la troisi√®me voie d&#8217;ex√©cution permet √† Abdul l&#8217;avocat de d√©penser les fonds seul, mais seulement apr√®s 90 jours. Pour s√©lectionner ce chemin d&#8217;ex√©cution, le script de d√©verrouillage doit se terminer par FALSE¬†:</p>
</div>
<div class="listingblock data-line-622">
<div class="title">Script de d√©verrouillage pour le troisi√®me chemin d&#8217;ex√©cution (avocat uniquement)</div>
<div class="content">
<pre>&lt;Abdul the Lawyer's Sig&gt; FALSE</pre>
</div>
</div>
<div class="paragraph data-line-626">
<p>Essayez d&#8217;ex√©cuter le script sur papier pour voir comment il se comporte sur la pile.</p>
</div>
<div class="paragraph data-line-628">
<p>Quelques √©l√©ments suppl√©mentaires √† prendre en compte lors de la lecture de cet exemple. Voyez si vous pouvez trouver les r√©ponses¬†:</p>
</div>
<div class="ulist data-line-630">
<ul>
<li class="data-line-630">
<p>Pourquoi l&#8217;avocat ne peut-il pas racheter le troisi√®me chemin d&#8217;ex√©cution √† tout moment en le s√©lectionnant avec <code>FALSE</code> sur le script de d√©verrouillage¬†?</p>
</li>
<li class="data-line-632">
<p>Combien de chemins d&#8217;ex√©cution peuvent √™tre utilis√©s 5, 35 et 105 jours, respectivement, apr√®s le minage de l&#8217;UTXO¬†?</p>
</li>
<li class="data-line-634">
<p>Les fonds sont-ils perdus si l&#8217;avocat perd sa cl√© ? Votre r√©ponse change-t-elle si 91 jours se sont √©coul√©s¬†?</p>
</li>
<li class="data-line-636">
<p>Comment les associ√©s ¬´ remettent-ils √† z√©ro ¬ª l&#8217;horloge tous les 29 ou 89 jours pour emp√™cher l&#8217;avocat d&#8217;acc√©der aux fonds ?</p>
</li>
<li class="data-line-638">
<p>Pourquoi certains opcodes <code>CHECKSIG</code> dans ce script ont-ils le suffixe <code>VERIFY</code> alors que d&#8217;autres non¬†?</p>
</li>
</ul>
</div>
</div>
<div class="sect2 data-line-641">
<h3 id="segwit">T√©moin s√©par√©</h3>
<div class="paragraph data-line-643">
<p>Le Segregated Witness (segwit) ou le "t√©moin s√©par√©" est une mise √† niveau des r√®gles de consensus bitcoin et du protocole r√©seau, propos√©e et mise en ≈ìuvre en tant que embranchement convergent BIP-9 qui a √©t√© activ√© sur le r√©seau principal de bitcoin le 1er ao√ªt 2017.</p>
</div>
<div class="paragraph data-line-645">
<p>En cryptographie, le terme ¬´¬†t√©moin¬†¬ª est utilis√© pour d√©crire une solution √† un puzzle cryptographique. En termes de bitcoin, le t√©moin satisfait une condition cryptographique plac√©e sur une sortie de transaction non d√©pens√©e (UTXO).</p>
</div>
<div class="paragraph data-line-647">
<p>Dans le contexte du bitcoin, une signature num√©rique est <em>un type de t√©moin</em>, mais un t√©moin est plus largement toute solution qui peut satisfaire les conditions impos√©es √† un UTXO et d√©bloquer cet UTXO pour les d√©penses. Le terme "t√©moin" est un terme plus g√©n√©ral pour un "script de d√©verrouillage" ou "scriptSig".</p>
</div>
<div class="paragraph data-line-649">
<p>Avant l&#8217;introduction de segwit, chaque entr√©e d&#8217;une transaction √©tait suivie des donn√©es t√©moins qui la d√©verrouillaient. Les donn√©es t√©moins ont √©t√© int√©gr√©es √† la transaction dans le cadre de chaque entr√©e. Le terme <em>t√©moin s√©par√©</em>, ou <em>segwit</em> en abr√©g√©, signifie simplement s√©parer la signature ou le script de d√©verrouillage d&#8217;une sortie sp√©cifique. Pensez "scriptSig s√©par√©" ou "signature s√©par√©e" dans sa forme la plus simple.</p>
</div>
<div class="paragraph data-line-651">
<p>Le t√©moin s√©par√© (Segregated Witness) est donc une modification architecturale du bitcoin qui vise √† d√©placer les donn√©es t√©moins du champ <code>scriptSig</code> (script de d√©verrouillage) d&#8217;une transaction vers une structure de donn√©es <em>t√©moin</em> distincte qui accompagne une transaction. Les clients peuvent demander des donn√©es de transaction avec ou sans les donn√©es de t√©moin qui les accompagnent.</p>
</div>
<div class="paragraph data-line-653">
<p>Dans cette section, nous examinerons certains des avantages du t√©moin s√©par√©, d√©crirons le m√©canisme utilis√© pour d√©ployer et mettre en ≈ìuvre ce changement d&#8217;architecture et d√©montrerons l&#8217;utilisation du t√©moin s√©par√© dans les transactions et les adresses.</p>
</div>
<div class="paragraph data-line-655">
<p>Le t√©moin s√©par√© est d√©fini par les BIP suivants¬†:</p>
</div>
<div class="dlist data-line-657">
<dl>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki">BIP-141</a> </dt>
<dd>
<p>La principale d√©finition du t√©moin s√©par√©.</p>
</dd>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0143.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0143.mediawiki">BIP-143</a> </dt>
<dd>
<p>V√©rification de la signature des transactions pour le programme t√©moin de la version 0</p>
</dd>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0144.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0144.mediawiki">BIP-144</a> </dt>
<dd>
<p>Services √† pair; Nouveaux messages r√©seau et formats de s√©rialisation</p>
</dd>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0145.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0145.mediawiki">BIP-145</a> </dt>
<dd>
<p>Mises √† jour de getblocktemplate pour le t√©moin s√©par√© Segregated Witness (pour minage)</p>
</dd>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki">BIP-173</a> </dt>
<dd>
<p>Format d&#8217;adresse Base32 pour les sorties t√©moins natives v0-16</p>
</dd>
</dl>
</div>
<div class="sect3 data-line-668">
<h4 id="_pourquoi_un_t√©moin_s√©par√©">Pourquoi un t√©moin s√©par√©¬†?</h4>
<div class="paragraph data-line-670">
<p>Le t√©moin s√©par√© est un changement architectural qui a plusieurs effets sur l&#8217;√©volutivit√©, la s√©curit√©, les incitations √©conomiques et les performances du bitcoin¬†:</p>
</div>
<div class="dlist data-line-672">
<dl>
<dt class="hdlist1">Mall√©abilit√© de transaction </dt>
<dd>
<p>En d√©pla√ßant le t√©moin en dehors des donn√©es de transaction, le hachage de transaction utilis√© comme identifiant n&#8217;inclut plus les donn√©es de t√©moin. √âtant donn√© que les donn√©es t√©moins sont la seule partie de la transaction qui peut √™tre modifi√©e par un tiers (voir <a href="#segwit_txid">Identifiants de transaction</a>), sa suppression supprime √©galement la possibilit√© d&#8217;attaques de mall√©abilit√© des transactions. Avec le t√©moin s√©par√©, les hachages de transaction deviennent immuables par toute personne autre que le cr√©ateur de la transaction, ce qui am√©liore consid√©rablement la mise en ≈ìuvre de nombreux autres protocoles qui reposent sur la construction avanc√©e de transactions bitcoin, tels que les canaux de paiement, les transactions cha√Æn√©es et les r√©seaux Lightning.</p>
</dd>
<dt class="hdlist1">Gestion des versions de script </dt>
<dd>
<p>Avec l&#8217;introduction des scripts Segregated Witness (t√©moin s√©par√©), chaque script de verrouillage est pr√©c√©d√© d&#8217;un num√©ro de <em>version de script</em>, similaire √† la fa√ßon dont les transactions et les blocs ont des num√©ros de version. L&#8217;ajout d&#8217;un num√©ro de version de script permet au langage de script d&#8217;√™tre mis √† niveau de mani√®re r√©trocompatible (c&#8217;est-√†-dire en utilisant des mises √† niveau d&#8217;embranchement convergent) pour introduire de nouvelles op√©randes de script, syntaxe ou s√©mantique. La possibilit√© de mettre √† niveau le langage de script de mani√®re non perturbatrice acc√©l√©rera consid√©rablement le taux d&#8217;innovation dans le bitcoin.</p>
</dd>
<dt class="hdlist1">Mise √† l&#8217;√©chelle du r√©seau et du stockage </dt>
<dd>
<p>Les donn√©es t√©moins contribuent souvent de mani√®re importante √† la taille totale d&#8217;une transaction. Les scripts plus complexes tels que ceux utilis√©s pour les canaux multisig ou de paiement sont tr√®s volumineux. Dans certains cas, ces scripts repr√©sentent la majorit√© (plus de 75¬†%) des donn√©es d&#8217;une transaction. En d√©pla√ßant les donn√©es t√©moins en dehors des donn√©es de transaction, le t√©moin s√©par√© am√©liore l&#8217;√©volutivit√© de Bitcoin. Les n≈ìuds peuvent √©laguer les donn√©es t√©moins apr√®s avoir valid√© les signatures, ou les ignorer compl√®tement lors de la v√©rification simplifi√©e des paiements. Les donn√©es t√©moins n&#8217;ont pas besoin d&#8217;√™tre transmises √† tous les n≈ìuds et n&#8217;ont pas besoin d&#8217;√™tre stock√©es sur disque par tous les n≈ìuds.</p>
</dd>
<dt class="hdlist1">Optimisation de la v√©rification de signature </dt>
<dd>
<p>Le t√©moin s√©par√© met √† niveau les fonctions de signature (CHECKSIG, CHECKMULTISIG, etc.) pour r√©duire la complexit√© de calcul de l&#8217;algorithme. Avant segwit, l&#8217;algorithme utilis√© pour produire une signature n√©cessitait un nombre d&#8217;op√©rations de hachage proportionnel √† la taille de la transaction. Les calculs de hachage de donn√©es ont augment√© en O(n<sup>2</sup>) par rapport au nombre d&#8217;op√©rations de signature, introduisant une charge de calcul substantielle sur tous les n≈ìuds v√©rifiant la signature. Avec segwit, l&#8217;algorithme est modifi√© pour r√©duire la complexit√© √† O(n).</p>
</dd>
<dt class="hdlist1">Am√©lioration de la signature hors ligne </dt>
<dd>
<p>Les signatures des t√©moins s√©par√©s incorporent la valeur (montant) r√©f√©renc√©e par chaque entr√©e dans le hachage qui est sign√©. Auparavant, un dispositif de signature hors ligne, tel qu&#8217;un portefeuille mat√©riel, devait v√©rifier le montant de chaque entr√©e avant de signer une transaction. Cela √©tait g√©n√©ralement accompli en diffusant une grande quantit√© de donn√©es sur les transactions pr√©c√©dentes r√©f√©renc√©es en tant qu&#8217;entr√©es. √âtant donn√© que le montant fait d√©sormais partie du hachage d&#8217;engagement qui est sign√©, un appareil hors ligne n&#8217;a pas besoin des transactions pr√©c√©dentes. Si les montants ne correspondent pas (sont mal repr√©sent√©s par un syst√®me en ligne compromis), la signature sera invalide.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3 data-line-682">
<h4 id="_comment_fonctionne_le_t√©moignage_s√©par√©">Comment fonctionne le t√©moignage s√©par√©</h4>
<div class="paragraph data-line-684">
<p>√Ä premi√®re vue, le t√©moignage s√©par√© semble √™tre un changement dans la fa√ßon dont les transactions sont construites et donc une fonctionnalit√© au niveau de la transaction, mais ce n&#8217;est pas le cas. Au lieu de cela, le t√©moin s√©par√© est un changement dans la fa√ßon dont les UTXO individuels sont d√©pens√©s et est donc une fonctionnalit√© par sortie.</p>
</div>
<div class="paragraph data-line-686">
<p>Une transaction peut d√©penser des sorties de t√©moin s√©par√© ou des sorties traditionnelles (t√©moin en ligne) ou les deux. Par cons√©quent, cela n&#8217;a pas beaucoup de sens de se r√©f√©rer √† une transaction comme une "transaction de t√©moin s√©par√©". Nous devrions plut√¥t faire r√©f√©rence √† des sorties de transaction sp√©cifiques en tant que "sorties de t√©moins s√©par√©s".</p>
</div>
<div class="paragraph data-line-688">
<p>Lorsqu&#8217;une transaction passe un UTXO, elle doit fournir un t√©moin. Dans un UTXO traditionnel, le script de verrouillage n√©cessite que les donn√©es t√©moins soient fournies <em>en ligne</em> dans la partie d&#8217;entr√©e de la transaction qui d√©pense l&#8217;UTXO. Un UTXO de t√©moin s√©par√©, cependant, sp√©cifie un script de verrouillage qui peut √™tre satisfait avec des donn√©es de t√©moin en dehors de l&#8217;entr√©e (s√©par√©es).</p>
</div>
</div>
<div class="sect3 data-line-690">
<h4 id="_embranchement_convergent_r√©trocompatibilit√©">Embranchement convergent (r√©trocompatibilit√©)</h4>
<div class="paragraph data-line-692">
<p>Le t√©moin s√©par√© est un changement significatif dans la mani√®re dont les sorties et les transactions sont architectur√©es. Un tel changement n√©cessiterait normalement un changement simultan√© de chaque n≈ìud et portefeuille Bitcoin pour modifier les r√®gles de consensus, ce que l&#8217;on appelle une fourche dure. Au lieu de cela, un t√©moin s√©par√© est introduit avec un changement beaucoup moins perturbateur, qui est r√©trocompatible, connu sous le nom d&#8217;embranchement convergent. Ce type de mise √† niveau permet aux logiciels non mis √† niveau d&#8217;ignorer les modifications et de continuer √† fonctionner sans aucune interruption.</p>
</div>
<div class="paragraph data-line-694">
<p>Les sorties de t√©moins s√©par√©s sont construites de mani√®re √† ce que les syst√®mes plus anciens qui ne sont pas sensibles au segwit puissent toujours les valider. Pour un ancien portefeuille ou n≈ìud, une sortie de t√©moin s√©par√© ressemble √† une sortie que <em>n&#8217;importe qui peut d√©penser</em>. De telles sorties peuvent √™tre d√©pens√©es avec une signature vide, donc le fait qu&#8217;il n&#8217;y ait pas de signature √† l&#8217;int√©rieur de la transaction (elle est s√©par√©e) n&#8217;invalide pas la transaction. Cependant, les portefeuilles et les n≈ìuds de minage plus r√©cents voient la sortie du t√©moin s√©par√© et s&#8217;attendent √† trouver un t√©moin valide pour celle-ci dans les donn√©es de t√©moin de la transaction.</p>
</div>
</div>
<div class="sect3 data-line-696">
<h4 id="_exemples_de_t√©moins_s√©par√©s_et_exemples_de_transactions">Exemples de t√©moins s√©par√©s et exemples de transactions</h4>
<div class="paragraph data-line-698">
<p>Examinons quelques-uns de nos exemples de transactions et voyons comment ils changeraient avec le t√©moin s√©par√©. Nous verrons d&#8217;abord comment un paiement Pay-to-Public-Key-Hash (P2PKH) est transform√© avec le programme de t√©moignage s√©par√©. Ensuite, nous examinerons l&#8217;√©quivalent des t√©moins s√©par√©s pour les scripts Pay-to-Script-Hash (P2SH). Enfin, nous verrons comment les deux programmes de t√©moignage s√©par√© pr√©c√©dents peuvent √™tre int√©gr√©s dans un script P2SH.</p>
</div>
<div class="sect4 data-line-701">
<h5 id="p2wpkh">Pay-to-Witness-Public-Key-Hash (P2WPKH)</h5>
<div class="paragraph data-line-703">
<p>Dans <a href="#cup_of_coffee">[cup_of_coffee]</a>, Alice a cr√©√© une transaction pour payer Bob pour une tasse de caf√©. Cette transaction a cr√©√© une sortie P2PKH d&#8217;une valeur de 0,015 BTC pouvant √™tre d√©pens√©e par Bob. Le script de sortie ressemble √† ceci¬†:</p>
</div>
<div class="listingblock data-line-706">
<div class="title">Exemple de script de sortie P2PKH</div>
<div class="content">
<pre>DUP HASH160 ab68025513c3dbd2f7b92a94e0581f5d50f654e7 EQUALVERIFY CHECKSIG</pre>
</div>
</div>
<div class="paragraph data-line-710">
<p>Avec le t√©moin s√©par√©, Alice cr√©erait un script Pay-to-Witness-Public-Key-Hash (P2WPKH), qui ressemble √† ceci¬†:</p>
</div>
<div class="listingblock data-line-713">
<div class="title">Exemple de script de sortie P2WPKH</div>
<div class="content">
<pre>0 ab68025513c3dbd2f7b92a94e0581f5d50f654e7</pre>
</div>
</div>
<div class="paragraph data-line-717">
<p>Comme vous pouvez le voir, le script de verrouillage d&#8217;une sortie de t√©moin s√©par√© est beaucoup plus simple qu&#8217;une sortie traditionnelle. Il se compose de deux valeurs qui sont transmises √† la pile d&#8217;√©valuation du script. Pour un ancien client Bitcoin (non conscient de la technologie), les deux pouss√©es ressembleraient √† une sortie que n&#8217;importe qui peut d√©penser et ne n√©cessite pas de signature (ou plut√¥t, peut √™tre d√©pens√©e avec une signature vide). Pour un client segwit plus r√©cent, le premier chiffre (0) est interpr√©t√© comme un num√©ro de version (la <em>version t√©moin</em>) et la seconde partie (20 octets) est l&#8217;√©quivalent d&#8217;un script de verrouillage connu sous le nom de <em>programme t√©moin</em>. Le programme t√©moin de 20 octets est simplement le hachage de la cl√© publique, comme dans un script P2PKH.</p>
</div>
<div class="paragraph data-line-719">
<p>Examinons maintenant la transaction correspondante que Bob utilise pour d√©penser cette sortie. Pour le script d&#8217;origine (nonsegwit), la transaction de Bob devrait inclure une signature dans l&#8217;entr√©e de transaction¬†:</p>
</div>
<div class="listingblock data-line-722">
<div class="title">Transaction d√©cod√©e montrant une sortie P2PKH d√©pens√©e avec une signature</div>
<div class="content">
<pre>[...]
‚ÄúVin‚Äù : [
"txid": "0627052b6f28912f2703066a912ea577f2ce4da4caa5a5fbd8a57286c345c2f2",
"vout": 0,
     	 "scriptSig": ‚Äú&lt;Bob‚Äôs scriptSig&gt;‚Äù,
]
[...]</pre>
</div>
</div>
<div class="paragraph data-line-732">
<p>Cependant, pour passer la sortie du t√©moin s√©par√©, la transaction n&#8217;a pas de signature dans la partie d&#8217;entr√©e. Au lieu de cela, la transaction de Bob a un <code>scriptSig</code> vide dans les donn√©es de transaction (la premi√®re partie d&#8217;une transaction, qui inclut la partie d&#8217;entr√©e) et inclut sa signature dans les donn√©es t√©moins (la deuxi√®me partie d&#8217;une transaction, qui est s√©par√©e des donn√©es de transaction ):</p>
</div>
<div class="listingblock data-line-735">
<div class="title">Transaction d√©cod√©e montrant une sortie P2WPKH d√©pens√©e avec des donn√©es t√©moins s√©par√©es</div>
<div class="content">
<pre>[...]
‚ÄúVin‚Äù : [
"txid": "0627052b6f28912f2703066a912ea577f2ce4da4caa5a5fbd8a57286c345c2f2",
"vout": 0,
     	 "scriptSig": ‚Äú‚Äù,
]
[...]
‚Äúwitness‚Äù: ‚Äú&lt;Bob‚Äôs witness data&gt;‚Äù
[...]</pre>
</div>
</div>
</div>
<div class="sect4 data-line-747">
<h5 id="_construction_de_portefeuille_de_p2wpkh">Construction de portefeuille de P2WPKH</h5>
<div class="paragraph data-line-749">
<p>Il est extr√™mement important de noter que P2WPKH ne doit √™tre cr√©√© que par le b√©n√©ficiaire (destinataire) et non converti par l&#8217;exp√©diteur √† partir d&#8217;une cl√© publique connue, d&#8217;un script P2PKH ou d&#8217;une adresse. Le destinataire n&#8217;a aucun moyen de savoir si le portefeuille de l&#8217;exp√©diteur a la capacit√© de construire des transactions segwit et de d√©penser les sorties P2WPKH.</p>
</div>
<div class="paragraph data-line-751">
<p>De plus, les sorties P2WPKH doivent √™tre construites √† partir du hachage d&#8217;une cl√© publique <em>compress√©e</em>. Les cl√©s publiques non compress√©es ne sont pas standard dans segwit et peuvent √™tre explicitement d√©sactiv√©es par un futur embranchement convergent. Si le hachage utilis√© dans le P2WPKH provient d&#8217;une cl√© publique non compress√©e, il peut √™tre inutilisable et vous risquez de perdre des fonds. Les sorties P2WPKH doivent √™tre cr√©√©es par le portefeuille du b√©n√©ficiaire en d√©rivant une cl√© publique compress√©e √† partir de sa cl√© priv√©e.</p>
</div>
<div class="admonitionblock warning data-line-754">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-755">
<p>P2WPKH doit √™tre construit par le b√©n√©ficiaire (destinataire) en convertissant une cl√© publique compress√©e en un hachage P2WPKH. Vous ne devez jamais transformer un script P2PKH, une adresse Bitcoin ou une cl√© publique non compress√©e en un script t√©moin P2WPKH.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4 data-line-759">
<h5 id="p2wsh">Pay-to-Witness-Script-Hash (P2WSH)</h5>
<div class="paragraph data-line-761">
<p>Le deuxi√®me type de programme t√©moin correspond √† un script Pay-to-Script-Hash (P2SH). Nous avons vu ce type de script dans <a href="#p2sh">Pay-to-Script-Hash (P2SH)</a>. Dans cet exemple, P2SH a √©t√© utilis√© par la soci√©t√© de Mohammed pour exprimer un script multisignature. Les paiements √† l&#8217;entreprise de Mohammed √©taient encod√©s avec un script de verrouillage comme celui-ci¬†:</p>
</div>
<div class="listingblock data-line-764">
<div class="title">Exemple de script de sortie P2SH</div>
<div class="content">
<pre>HASH160 54c557e07dde5bb6cb791c7a540e0a4796f5e97e EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-768">
<p>Ce script P2SH fait r√©f√©rence au hachage d&#8217;un <em>script d&#8217;√©change</em> qui d√©finit une exigence multisignature 2 sur 5 pour d√©penser des fonds. Pour d√©penser cette sortie, la soci√©t√© de Mohammed pr√©senterait le script de rachat (dont le hachage correspond au hachage du script dans la sortie P2SH) et les signatures n√©cessaires pour satisfaire ce script de rachat, le tout dans l&#8217;entr√©e de transaction¬†:</p>
</div>
<div class="listingblock data-line-771">
<div class="title">Transaction d√©cod√©e montrant qu&#8217;une sortie P2SH est d√©pens√©e</div>
<div class="content">
<pre>[...]
‚ÄúVin‚Äù : [
"txid": "abcdef12345...",
"vout": 0,
     	 "scriptSig": ‚Äú&lt;SigA&gt; &lt;SigB&gt; &lt;2 PubA PubB PubC PubD PubE 5 CHECKMULTISIG&gt;‚Äù,
]</pre>
</div>
</div>
<div class="paragraph data-line-780">
<p>Maintenant, regardons comment cet exemple entier serait mis √† niveau vers segwit. Si les clients de Mohammed utilisaient un portefeuille compatible segwit, ils effectueraient un paiement, cr√©ant une sortie Pay-to-Witness-Script-Hash (P2WSH) qui ressemblerait √† ceci¬†:</p>
</div>
<div class="listingblock data-line-783">
<div class="title">Exemple de script de sortie P2WSH</div>
<div class="content">
<pre>0 a9b7b38d972cabc7961dbfbcb841ad4508d133c47ba87457b4a0e8aae86dbb89</pre>
</div>
</div>
<div class="paragraph data-line-787">
<p>Encore une fois, comme dans l&#8217;exemple de P2WPKH, vous pouvez voir que le script √©quivalent Segregated Witness est beaucoup plus simple et omet les diff√©rents op√©randes de script que vous voyez dans les scripts P2SH. Au lieu de cela, le programme de t√©moignage s√©par√© se compose de deux valeurs pouss√©es vers la pile¬†: une version t√©moin (0) et le hachage SHA256 de 32 octets du script de rachat.</p>
</div>
<div class="paragraph data-line-789">
<p>La soci√©t√© de Mohammed peut d√©penser la sortie P2WSH en pr√©sentant le bon script de rachat et suffisamment de signatures pour le satisfaire. Le script de rachat et les signatures seraient s√©par√©s <em>en dehors</em> des donn√©es de transaction de d√©penses dans le cadre des donn√©es de t√©moin. Dans l&#8217;entr√©e de transaction, le portefeuille de Mohammed mettrait un <code>scriptSig</code> vide¬†:</p>
</div>
<div class="listingblock data-line-792">
<div class="title">Transaction d√©cod√©e montrant une sortie P2WSH d√©pens√©e avec des donn√©es t√©moins s√©par√©es</div>
<div class="content">
<pre>[...]
‚ÄúVin‚Äù : [
"txid": "abcdef12345...",
"vout": 0,
     	 "scriptSig": ‚Äú‚Äù,
]
[...]
‚Äúwitness‚Äù: ‚Äú&lt;SigA&gt; &lt;SigB&gt; &lt;2 PubA PubB PubC PubD PubE 5 CHECKMULTISIG&gt;‚Äù
[...]</pre>
</div>
</div>
<div class="admonitionblock tip data-line-805">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-806">
<p>Alors que P2SH utilise le hachage <code>RIPEMD160(SHA256(script))</code> de 20 octets, le programme t√©moin P2WSH utilise un hachage <code>SHA256(script)</code> de 32 octets. Cette diff√©rence dans le choix de l&#8217;algorithme de hachage est d√©lib√©r√©e et offre une s√©curit√© renforc√©e √† P2WSH (128 bits de s√©curit√© dans P2WSH contre 80 bits de s√©curit√© dans P2SH). Il est √©galement utilis√© pour diff√©rencier les deux types de programmes t√©moins (P2WPKH et P2WSH) en utilisant la longueur du hachage (voir ci-dessous).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4 data-line-810">
<h5 id="_diff√©renciation_entre_p2wpkh_et_p2wsh">Diff√©renciation entre P2WPKH et P2WSH</h5>
<div class="paragraph data-line-812">
<p>Dans les deux sections pr√©c√©dentes, nous avons pr√©sent√© deux types de programmes de t√©moins¬†: <a href="#p2wpkh">Pay-to-Witness-Public-Key-Hash (P2WPKH)</a> et <a href="#p2wsh">Pay-to-Witness-Script-Hash (P2WSH)</a>. Les deux types de programmes t√©moins se composent d&#8217;un num√©ro de version √† un seul octet suivi d&#8217;un hachage plus long. Ils se ressemblent beaucoup, mais sont interpr√©t√©s tr√®s diff√©remment¬†: l&#8217;un est interpr√©t√© comme un hachage de cl√© publique, qui est satisfait par une signature et l&#8217;autre comme un hachage de script, qui est satisfait par un script de rachat. La diff√©rence critique entre eux est la longueur du hachage¬†:</p>
</div>
<div class="ulist data-line-814">
<ul>
<li class="data-line-814">
<p>Le hachage de cl√© publique dans P2WPKH est de 20 octets</p>
</li>
<li class="data-line-815">
<p>Le hachage du script dans P2WSH est de 32 octets</p>
</li>
</ul>
</div>
<div class="paragraph data-line-817">
<p>C&#8217;est la seule diff√©rence qui permet √† un portefeuille de diff√©rencier les deux types de programmes de t√©moins. En examinant la longueur du hachage, un portefeuille peut d√©terminer de quel type de programme t√©moin il s&#8217;agit, P2WPKH ou P2WSH.</p>
</div>
</div>
</div>
<div class="sect3 data-line-819">
<h4 id="_mise_√†_niveau_vers_un_t√©moin_s√©par√©">Mise √† niveau vers un t√©moin s√©par√©</h4>
<div class="paragraph data-line-821">
<p>Comme nous pouvons le voir dans les exemples pr√©c√©dents, la mise √† niveau vers les t√©moins s√©par√©s est un processus en deux √©tapes. Tout d&#8217;abord, les portefeuilles doivent cr√©er des sorties sp√©ciales de type segwit. Ensuite, ces sorties peuvent √™tre d√©pens√©es par des portefeuilles qui savent comment construire des transactions de t√©moin s√©par√©. Dans les exemples, le portefeuille d&#8217;Alice √©tait sensible au segwit et capable de cr√©er des sorties sp√©ciales avec des scripts de t√©moignage s√©par√©s. Le portefeuille de Bob est √©galement sensible au segwit et capable de d√©penser ces sorties. Ce qui n&#8217;est peut-√™tre pas √©vident √† partir de l&#8217;exemple, c&#8217;est qu&#8217;en pratique, le portefeuille d&#8217;Alice doit <em>savoir</em> que Bob utilise un portefeuille sensible au segwit et peut d√©penser ces sorties. Sinon, si le portefeuille de Bob n&#8217;est pas mis √† niveau et qu&#8217;Alice essaie d&#8217;effectuer des paiements en segwit √† Bob, le portefeuille de Bob ne pourra pas d√©tecter ces paiements.</p>
</div>
<div class="admonitionblock tip data-line-824">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-825">
<p>Pour les types de paiement P2WPKH et P2WSH, les portefeuilles de l&#8217;exp√©diteur et du destinataire doivent √™tre mis √† niveau pour pouvoir utiliser segwit. De plus, le portefeuille de l&#8217;exp√©diteur doit savoir que le portefeuille du destinataire est sensible au segwit.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-828">
<p>Le t√©moin s√©par√© ne sera pas mis en ≈ìuvre simultan√©ment sur l&#8217;ensemble du r√©seau. Au lieu de cela, Segregated Witness est impl√©ment√© comme une mise √† niveau r√©trocompatible, o√π <em>les anciens et les nouveaux clients peuvent coexister</em>. Les d√©veloppeurs de portefeuille mettront ind√©pendamment √† niveau le logiciel de portefeuille pour ajouter des fonctionnalit√©s segwit. Les types de paiement P2WPKH et P2WSH sont utilis√©s lorsque l&#8217;exp√©diteur et le destinataire sont conscients de segwit. Les P2PKH et P2SH traditionnels continueront de fonctionner pour les portefeuilles non mis √† niveau. Cela laisse deux sc√©narios importants, qui sont abord√©s dans la section suivante¬†:</p>
</div>
<div class="ulist data-line-830">
<ul>
<li class="data-line-830">
<p>Capacit√© du portefeuille d&#8217;un exp√©diteur qui n&#8217;est pas conscient de segwit √† effectuer un paiement sur le portefeuille d&#8217;un destinataire qui peut traiter des transactions segwit</p>
</li>
<li class="data-line-832">
<p>Capacit√© du portefeuille d&#8217;un exp√©diteur qui est conscient de segwit √† reconna√Ætre et √† distinguer les destinataires qui sont conscients de segwit et ceux qui ne le sont pas, par leurs <em>adresses</em>.</p>
</li>
</ul>
</div>
<div class="sect4 data-line-834">
<h5 id="_int√©gration_dun_t√©moin_s√©par√©_dans_p2sh">Int√©gration d&#8217;un t√©moin s√©par√© dans P2SH</h5>
<div class="paragraph data-line-836">
<p>Supposons, par exemple, que le portefeuille d&#8217;Alice n&#8217;est pas mis √† niveau vers segwit, mais que le portefeuille de Bob est mis √† niveau et peut g√©rer les transactions segwit. Alice et Bob peuvent utiliser les "anciennes" transactions non-segwit. Mais Bob voudrait probablement utiliser segwit pour r√©duire les frais de transaction, en profitant de la remise qui s&#8217;applique aux donn√©es des t√©moins.</p>
</div>
<div class="paragraph data-line-838">
<p>Dans ce cas, le portefeuille de Bob peut construire une adresse P2SH qui contient un script segwit √† l&#8217;int√©rieur. Le portefeuille d&#8217;Alice consid√®re cela comme une adresse P2SH "normale" et peut y effectuer des paiements sans aucune connaissance de segwit. Le portefeuille de Bob peut ensuite d√©penser ce paiement avec une transaction segwit, tirant pleinement parti de segwit et r√©duisant les frais de transaction.</p>
</div>
<div class="paragraph data-line-840">
<p>Les deux formes de scripts t√©moins, P2WPKH et P2WSH, peuvent √™tre int√©gr√©es dans une adresse P2SH. Le premier est not√© P2SH(P2WPKH) et le second est not√© P2SH(P2WSH).</p>
</div>
</div>
<div class="sect4 data-line-842">
<h5 id="_pay_to_witness_public_key_hash_dans_pay_to_script_hash">Pay-to-Witness-Public-Key-Hash dans Pay-to-Script-Hash</h5>
<div class="paragraph data-line-844">
<p>La premi√®re forme de script t√©moin que nous examinerons est P2SH(P2WPKH). Il s&#8217;agit d&#8217;un programme t√©moin Pay-to-Witness-Public-Key-Hash, int√©gr√© dans un script Pay-to-Script-Hash, afin qu&#8217;il puisse √™tre utilis√© par un portefeuille qui n&#8217;est pas conscient de segwit.</p>
</div>
<div class="paragraph data-line-846">
<p>Le portefeuille de Bob construit un programme t√©moin P2WPKH avec la cl√© publique de Bob. Ce programme t√©moin est ensuite hach√© et le hachage r√©sultant est encod√© sous la forme d&#8217;un script P2SH. Le script P2SH est converti en une adresse Bitcoin, celle qui commence par un "3", comme nous l&#8217;avons vu dans le <a href="#p2sh">Pay-to-Script-Hash (P2SH)</a> rubrique.</p>
</div>
<div class="paragraph data-line-848">
<p>Le portefeuille de Bob commence par le programme t√©moin P2WPKH que nous avons vu plus t√¥t¬†:</p>
</div>
<div class="listingblock data-line-851">
<div class="title">Programme de t√©moins P2WPKH de Bob</div>
<div class="content">
<pre>0 ab68025513c3dbd2f7b92a94e0581f5d50f654e7</pre>
</div>
</div>
<div class="paragraph data-line-855">
<p>Le programme t√©moin P2WPKH se compose de la version t√©moin et du hachage de cl√© publique de 20 octets de Bob.</p>
</div>
<div class="paragraph data-line-857">
<p>Le portefeuille de Bob hache ensuite le programme t√©moin pr√©c√©dent, d&#8217;abord avec SHA256, puis avec RIPEMD160, produisant un autre hachage de 20 octets.</p>
</div>
<div class="paragraph data-line-859">
<p>Utilisons <code>bx</code> sur la ligne de commande pour r√©pliquer cela¬†:</p>
</div>
<div class="listingblock data-line-862">
<div class="title">HASH160 du programme t√©moin P2WPKH</div>
<div class="content">
<pre>echo \
'0 [ab68025513c3dbd2f7b92a94e0581f5d50f654e7]'\
 | bx script-encode | bx sha256 | bx ripemd160
3e0547268b3b19288b3adef9719ec8659f4b2b0b</pre>
</div>
</div>
<div class="paragraph data-line-870">
<p>Ensuite, le hachage du script de rachat est converti en une adresse Bitcoin. Utilisons √† nouveau <code>bx</code> sur la ligne de commande¬†:</p>
</div>
<div class="listingblock data-line-873">
<div class="title">Adresse P2SH</div>
<div class="content">
<pre>echo \
'3e0547268b3b19288b3adef9719ec8659f4b2b0b' \
| bx address-encode -v 5
37Lx99uaGn5avKBxiW26HjedQE3LrDCZru</pre>
</div>
</div>
<div class="paragraph data-line-880">
<p>Maintenant, Bob peut afficher cette adresse pour que les clients paient leur caf√©. Le portefeuille d&#8217;Alice peut effectuer un paiement au 37Lx99uaGn5avKBxiW26HjedQE3LrDCZru, comme il le ferait avec n&#8217;importe quelle autre adresse Bitcoin.</p>
</div>
<div class="paragraph data-line-882">
<p>Pour payer Bob, le portefeuille d&#8217;Alice verrouillerait la sortie avec un script P2SH¬†:</p>
</div>
<div class="listingblock data-line-883">
<div class="content">
<pre>HASH160 3e0547268b3b19288b3adef9719ec8659f4b2b0b EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-887">
<p>M√™me si le portefeuille d&#8217;Alice ne prend pas en charge segwit, le paiement qu&#8217;il cr√©e peut √™tre d√©pens√© par Bob avec une transaction segwit.</p>
</div>
</div>
<div class="sect4 data-line-889">
<h5 id="_pay_to_witness_script_hash_dans_pay_to_script_hash">Pay-to-Witness-Script-Hash dans Pay-to-Script-Hash</h5>
<div class="paragraph data-line-891">
<p>De m√™me, un programme t√©moin P2WSH pour un script multisig ou un autre script compliqu√© peut √™tre int√©gr√© dans un script et une adresse P2SH, permettant √† n&#8217;importe quel portefeuille d&#8217;effectuer des paiements compatibles avec segwit.</p>
</div>
<div class="paragraph data-line-893">
<p>Comme nous l&#8217;avons vu dans <a href="#p2wsh">Pay-to-Witness-Script-Hash (P2WSH)</a>, la soci√©t√© de Mohammed  utilise des paiements de t√©moins s√©par√©s avec des scripts multisignatures. Pour permettre √† tout client de payer son entreprise, que ses portefeuilles soient ou non mis √† niveau pour segwit, le portefeuille de Mohammed peut int√©grer le programme t√©moin P2WSH dans un script P2SH.</p>
</div>
<div class="paragraph data-line-895">
<p>Tout d&#8217;abord, le portefeuille de Mohammed hache le script de rachat avec SHA256 (une seule fois). Utilisons <code>bx</code> pour faire cela sur la ligne de commande¬†:</p>
</div>
<div class="listingblock data-line-898">
<div class="title">Le portefeuille de Mohammed cr√©e un programme t√©moin P2WSH</div>
<div class="content">
<pre>echo \
2 \ [04C16B8698A9ABF84250A7C3EA7EEDEF9897D1C8C6ADF47F06CF73370D74DCCA01CDCA79DCC5C395D7EEC6984D83F1F50C900A24DD47F569FD4193AF5DE762C587] \
[04A2192968D8655D6A935BEAF2CA23E3FB87A3495E7AF308EDF08DAC3C1FCBFC2C75B4B0F4D0B1B70CD2423657738C0C2B1D5CE65C97D78D0E34224858008E8B49] \
[047E63248B75DB7379BE9CDA8CE5751D16485F431E46117B9D0C1837C9D5737812F393DA7D4420D7E1A9162F0279CFC10F1E8E8F3020DECDBC3C0DD389D9977965] \
[0421D65CBD7149B255382ED7F78E946580657EE6FDA162A187543A9D85BAAA93A4AB3A8F044DADA618D087227440645ABE8A35DA8C5B73997AD343BE5C2AFD94A5] \
[043752580AFA1ECED3C68D446BCAB69AC0BA7DF50D56231BE0AABF1FDEEC78A6A45E394BA29A1EDF518C022DD618DA774D207D137AAB59E0B000EB7ED238F4D800] \
5 CHECKMULTISIG \
| bx script-encode | bx sha256
9592d601848d04b172905e0ddb0adde59f1590f1e553ffc81ddc4b0ed927dd73</pre>
</div>
</div>
<div class="paragraph data-line-910">
<p>Ensuite, le script de rachat hach√© est transform√© en un programme t√©moin P2WSH¬†:</p>
</div>
<div class="listingblock data-line-912">
<div class="content">
<pre>0 9592d601848d04b172905e0ddb0adde59f1590f1e553ffc81ddc4b0ed927dd73</pre>
</div>
</div>
<div class="paragraph data-line-916">
<p>Ensuite, le programme t√©moin lui-m√™me est hach√© avec SHA256 et RIPEMD160, produisant un nouveau hachage de 20 octets, tel qu&#8217;utilis√© dans le P2SH traditionnel. Utilisons <code>bx</code> sur la ligne de commande pour faire cela¬†:</p>
</div>
<div class="listingblock data-line-919">
<div class="title">Le HASH160 du programme t√©moin P2WSH</div>
<div class="content">
<pre> echo \
'0 [9592d601848d04b172905e0ddb0adde59f1590f1e553ffc81ddc4b0ed927dd73]'\
 | bx script-encode | bx sha256 | bx ripemd160
86762607e8fe87c0c37740cddee880988b9455b2</pre>
</div>
</div>
<div class="paragraph data-line-926">
<p>Ensuite, le portefeuille construit une adresse Bitcoin P2SH √† partir de ce hachage. Encore une fois, nous utilisons <code>bx</code> pour calculer sur la ligne de commande¬†:</p>
</div>
<div class="listingblock data-line-929">
<div class="title">P2SH Adresse bitcoin</div>
<div class="content">
<pre>echo \
'86762607e8fe87c0c37740cddee880988b9455b2'\
 | bx address-encode -v 5
3Dwz1MXhM6EfFoJChHCxh1jWHb8GQqRenG</pre>
</div>
</div>
<div class="paragraph data-line-936">
<p>D√©sormais, les clients de Mohammed peuvent effectuer des paiements √† cette adresse sans avoir besoin de prendre en charge segwit. Pour envoyer un paiement √† Mohammed, un portefeuille verrouillerait la sortie avec le script P2SH suivant¬†:</p>
</div>
<div class="listingblock data-line-939">
<div class="title">Script P2SH utilis√© pour verrouiller les paiements sur le multisig de Mohammed</div>
<div class="content">
<pre>HASH160 86762607e8fe87c0c37740cddee880988b9455b2 EQUAL</pre>
</div>
</div>
<div class="paragraph data-line-943">
<p>La soci√©t√© de Mohammed peut alors construire des transactions segwit pour d√©penser ces paiements, en tirant parti des fonctionnalit√©s segwit, notamment des frais de transaction moins √©lev√©s.</p>
</div>
</div>
<div class="sect4 data-line-945">
<h5 id="_adresses_de_t√©moins_s√©par√©s">Adresses de t√©moins s√©par√©s</h5>
<div class="paragraph data-line-947">
<p>M√™me apr√®s l&#8217;activation de segwit, il faudra un certain temps avant que la plupart des portefeuilles soient mis √† niveau. Dans un premier temps, segwit sera int√©gr√© √† P2SH, comme nous l&#8217;avons vu dans la section pr√©c√©dente, pour faciliter la compatibilit√© entre les portefeuilles prenant en charge et ignorants de segwit.</p>
</div>
<div class="paragraph data-line-949">
<p>Cependant, une fois que les portefeuilles prennent largement en charge segwit, il est logique d&#8217;encoder les scripts t√©moins directement dans un format d&#8217;adresse natif con√ßu pour segwit, plut√¥t que de l&#8217;int√©grer dans P2SH.</p>
</div>
<div class="paragraph data-line-951">
<p>Le format d&#8217;adresse segwit natif est d√©fini dans BIP-173¬†:</p>
</div>
<div class="dlist data-line-953">
<dl>
<dt class="hdlist1"><a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki" data-href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki">BIP-173</a> </dt>
<dd>
<p>Format d&#8217;adresse Base32 pour les sorties t√©moins natives v0-16</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-955">
<p>BIP-173 encode uniquement les scripts t√©moins (P2WPKH et P2WSH). Il n&#8217;est pas compatible avec les scripts P2PKH ou P2SH non-segwit. BIP-173 est un encodage Base32 √† somme de contr√¥le, par rapport √† l&#8217;encodage Base58 d&#8217;une adresse Bitcoin "traditionnelle". Les adresses BIP-173 sont √©galement appel√©es adresses <em>bech32</em>, prononc√©es "beh-ch trente-deux", faisant allusion √† l&#8217;utilisation d&#8217;un algorithme de d√©tection d&#8217;erreur "BCH" et d&#8217;un ensemble de codage √† 32 caract√®res.</p>
</div>
<div class="paragraph data-line-957">
<p>Les adresses BIP-173 utilisent un jeu de 32 caract√®res alphanum√©riques en minuscules uniquement, soigneusement s√©lectionn√©s pour r√©duire les erreurs de lecture ou de frappe. En choisissant un jeu de caract√®res en minuscules uniquement, bech32 est plus facile √† lire, √† parler et 45¬†% plus efficace pour encoder dans les codes QR.</p>
</div>
<div class="paragraph data-line-959">
<p>L&#8217;algorithme de d√©tection d&#8217;erreurs BCH est une grande am√©lioration par rapport √† l&#8217;algorithme de somme de contr√¥le pr√©c√©dent (de Base58Check), permettant non seulement la d√©tection mais aussi la <em>correction</em> des erreurs. Les interfaces de saisie d&#8217;adresse (telles que les champs de texte dans les formulaires) peuvent d√©tecter et mettre en √©vidence le caract√®re le plus susceptible d&#8217;√™tre mal saisi lorsqu&#8217;elles d√©tectent une erreur.</p>
</div>
<div class="paragraph data-line-961">
<p>De la sp√©cification BIP-173, voici quelques exemples d&#8217;adresses bech32¬†:</p>
</div>
<div class="dlist data-line-963">
<dl>
<dt class="hdlist1">Mainnet P2WPKH</dt>
<dd>
<p>bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4</p>
</dd>
<dt class="hdlist1">Testnet P2WPKH</dt>
<dd>
<p>tb1qw508d6qejxtdg4y5r3zarvary0c5xw7kxpjzsx</p>
</dd>
<dt class="hdlist1">Mainnet P2WSH</dt>
<dd>
<p>bc1qrp33g0q5c5txsp9arysrx4k6zdkfs4nce4xj0gdcccefvpysxf3qccfmv3</p>
</dd>
<dt class="hdlist1">Testnet P2WSH</dt>
<dd>
<p>tb1qrp33g0q5c5txsp9arysrx4k6zdkfs4nce4xj0gdcccefvpysxf3q0sl5k7</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-968">
<p>Comme vous pouvez le voir dans ces exemples, une cha√Æne segwit bech32 contient jusqu&#8217;√† 90 caract√®res et se compose de trois parties¬†:</p>
</div>
<div class="dlist data-line-970">
<dl>
<dt class="hdlist1">La partie lisible par l&#8217;homme</dt>
<dd>
<p>Ce pr√©fixe "bc" ou "tb" identifiant mainnet ou testnet</p>
</dd>
<dt class="hdlist1">Le s√©parateur</dt>
<dd>
<p>Le chiffre "1", qui ne fait pas partie du jeu de codage √† 32 caract√®res et ne peut appara√Ætre qu&#8217;√† cette position en tant que s√©parateur</p>
</dd>
<dt class="hdlist1">La partie donn√©es</dt>
<dd>
<p>Un minimum de 6 caract√®res alphanum√©riques, le script t√©moin encod√© par somme de contr√¥le</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-976">
<p>√Ä l&#8217;heure actuelle, seuls quelques portefeuilles acceptent ou produisent des adresses segwit bech32 natives, mais √† mesure que l&#8217;adoption de segwit augmente, vous les verrez de plus en plus souvent.</p>
</div>
<div class="paragraph data-line-978">
<p><a href="#segwit_addresses">Bitcoin non-segwit (h√©rit√©) et adresses segwit</a> affiche les adresses bitcoin non-segwit (h√©rit√©es) et segwit.</p>
</div>
<table id="segwit_addresses" class="tableblock frame-all grid-all stretch data-line-982">
<caption class="title">Table 3. Bitcoin non-segwit (h√©rit√©) et adresses segwit</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encodage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pr√©fixe</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse P2PKH h√©rit√©e</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ancienne adresse Testnet P2PKH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">m ou n</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ancienne adresse P2SH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ancienne adresse Testnet P2SH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse Segwit P2SH(P2WPKH) imbriqu√©e (int√©gr√©e)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse Segwit P2SH(P2WSH) imbriqu√©e (int√©gr√©e)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base58</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse native Segwit P2WPKH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bech32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bc1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse native Segwit Testnet P2WPKH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bech32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tb1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse native Segwit P2WSH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bech32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bc1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adresse native Segwit Testnet P2WSH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bech32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tb1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4 data-line-997">
<h5 id="segwit_txid">Identifiants de transaction</h5>
<div class="paragraph data-line-999">
<p>L&#8217;un des plus grands avantages des t√©moin s√©par√©s est qu&#8217;il √©limine la mall√©abilit√© des transactions tierces.</p>
</div>
<div class="paragraph data-line-1001">
<p>Avant segwit, les transactions pouvaient voir leurs signatures subtilement modifi√©es par des tiers, changeant leur ID de transaction (hachage) sans changer aucune propri√©t√© fondamentale (entr√©es, sorties, montants). Cela a cr√©√© des opportunit√©s d&#8217;attaques par d√©ni de service ainsi que des attaques contre des logiciels de portefeuille mal √©crits qui supposaient que les hachages de transaction non confirm√©s √©taient immuables.</p>
</div>
<div class="paragraph data-line-1003">
<p>Avec l&#8217;introduction des t√©moins s√©par√©s, les transactions ont deux identifiants, <code>txid</code> et wtxid. L&#8217;identifiant de transaction traditionnel <code>txid</code> est le hachage double SHA256 de la transaction s√©rialis√©e, sans les donn√©es t√©moins. Une transaction <code>wtxid</code> est le hachage double SHA256 du nouveau format de s√©rialisation de la transaction avec des donn√©es t√©moins.</p>
</div>
<div class="paragraph data-line-1005">
<p>Le <code>txid</code> traditionnel est calcul√© exactement de la m√™me mani√®re qu&#8217;avec une transaction non segwit. Cependant, √©tant donn√© qu&#8217;une transaction segwit pure (une transaction qui ne contient que des entr√©es segwit) a des <code>scriptSig</code> vides dans chaque entr√©e, aucune partie de la transaction ne peut √™tre modifi√©e par un tiers. Par cons√©quent, dans une transaction segwit pure, le <code>txid</code> est immuable par un tiers, m√™me lorsque la transaction n&#8217;est pas confirm√©e.</p>
</div>
<div class="paragraph data-line-1007">
<p>Le <code>wtxid</code> est comme un identifiant "√©tendu", en ce que le hachage incorpore √©galement les donn√©es du t√©moin. Si une transaction est transmise sans donn√©es t√©moins, alors le <code>wtxid</code> et le <code>txid</code> sont identiques. Notez que puisque le <code>wtxid</code> inclut des donn√©es t√©moins (signatures) et que les donn√©es t√©moins peuvent √™tre mall√©ables, le <code>wtxid</code> doit √™tre consid√©r√© comme mall√©able jusqu&#8217;√† ce que la transaction soit confirm√©e. Seul le <code>txid</code> d&#8217;une pure transaction segwit peut √™tre consid√©r√© comme immuable par des tiers.</p>
</div>
<div class="admonitionblock tip data-line-1010">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-1011">
<p>Les transactions de t√©moin s√©par√© ont deux identifiants¬†: <code>txid</code> et wtxid. Le <code>txid</code> est le hachage de la transaction sans les donn√©es t√©moins et le <code>wtxid</code> est le hachage incluant les donn√©es t√©moins. Seules les transactions segwit pures (transactions qui ne contiennent que des entr√©es segwit) ont un <code>txid</code> qui n&#8217;est pas sensible √† la mall√©abilit√© des transactions tierces.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3 data-line-1014">
<h4 id="_nouvel_algorithme_de_signature_des_t√©moins_s√©par√©s">Nouvel algorithme de signature des t√©moins s√©par√©s</h4>
<div class="paragraph data-line-1016">
<p>Le t√©moin s√©par√© modifie la s√©mantique des quatre fonctions de v√©rification de signature (CHECKSIG, CHECKSIGVERIFY, <code>CHECKMULTISIG</code> et CHECKMULTISIGVERIFY), changeant la fa√ßon dont un hachage d&#8217;engagement de transaction est calcul√©.</p>
</div>
<div class="paragraph data-line-1018">
<p>Les signatures dans les transactions bitcoin sont appliqu√©es sur un <em>hachage d&#8217;engagement</em>, qui est calcul√© √† partir des donn√©es de transaction, verrouillant des parties sp√©cifiques des donn√©es indiquant l&#8217;engagement du signataire envers ces valeurs. Par exemple, dans une signature de type <code>SIGHASH_ALL</code> simple, le hachage d&#8217;engagement inclut toutes les entr√©es et sorties.</p>
</div>
<div class="paragraph data-line-1020">
<p>Malheureusement, la fa√ßon dont le hachage d&#8217;engagement a √©t√© calcul√© a introduit la possibilit√© qu&#8217;un n≈ìud v√©rifiant la signature puisse √™tre forc√© d&#8217;effectuer un nombre important de calculs de hachage. Plus pr√©cis√©ment, les op√©rations de hachage augmentent en O(n<sup>2</sup>) par rapport au nombre d&#8217;op√©rations de signature dans la transaction. Un attaquant pourrait donc cr√©er une transaction avec un tr√®s grand nombre d&#8217;op√©rations de signature, obligeant l&#8217;ensemble du r√©seau Bitcoin √† effectuer des centaines ou des milliers d&#8217;op√©rations de hachage pour v√©rifier la transaction.</p>
</div>
<div class="paragraph data-line-1022">
<p>Segwit repr√©sentait une opportunit√© de r√©soudre ce probl√®me en modifiant la fa√ßon dont le hachage d&#8217;engagement est calcul√©. Pour les programmes t√©moins segwit version 0, la v√©rification de la signature se produit √† l&#8217;aide d&#8217;un algorithme de hachage d&#8217;engagement am√©lior√©, comme sp√©cifi√© dans BIP-143.</p>
</div>
<div class="paragraph data-line-1024">
<p>Le nouvel algorithme atteint deux objectifs importants. Premi√®rement, le nombre d&#8217;op√©rations de hachage augmente d&#8217;un O(n) beaucoup plus graduel au nombre d&#8217;op√©rations de signature, r√©duisant la possibilit√© de cr√©er des attaques par d√©ni de service avec des transactions trop complexes. Deuxi√®mement, le hachage d&#8217;engagement inclut d√©sormais √©galement la valeur (montants) de chaque entr√©e dans le cadre de l&#8217;engagement. Cela signifie qu&#8217;un signataire peut s&#8217;engager sur une valeur d&#8217;entr√©e sp√©cifique sans avoir besoin de "r√©cup√©rer" et de v√©rifier la transaction pr√©c√©dente r√©f√©renc√©e par l&#8217;entr√©e. Dans le cas d&#8217;appareils hors ligne, tels que les portefeuilles mat√©riels, cela simplifie grandement la communication entre l&#8217;h√¥te et le portefeuille mat√©riel, supprimant la n√©cessit√© de diffuser les transactions pr√©c√©dentes pour validation. Un portefeuille mat√©riel peut accepter la valeur d&#8217;entr√©e "telle qu&#8217;elle est indiqu√©e" par un h√¥te non approuv√©. √âtant donn√© que la signature n&#8217;est pas valide si cette valeur d&#8217;entr√©e n&#8217;est pas correcte, le portefeuille mat√©riel n&#8217;a pas besoin de valider la valeur avant de signer l&#8217;entr√©e.</p>
</div>
</div>
<div class="sect3 data-line-1026">
<h4 id="_incitations_√©conomiques_pour_les_t√©moins_isol√©s">Incitations √©conomiques pour les t√©moins isol√©s</h4>
<div class="paragraph data-line-1028">
<p>Les n≈ìuds miniers Bitcoin et les n≈ìuds complets entra√Ænent des co√ªts pour les ressources utilis√©es pour prendre en charge le r√©seau Bitcoin et la cha√Æne de blocs. √Ä mesure que le volume de transactions bitcoin augmente, le co√ªt des ressources (CPU, bande passante r√©seau, espace disque, m√©moire) augmente √©galement. Les mineurs sont indemnis√©s pour ces co√ªts par des frais proportionnels √† la taille (en octets) de chaque transaction. Les n≈ìuds complets non miniers ne sont pas r√©mun√©r√©s, ils encourent donc ces co√ªts parce qu&#8217;ils ont besoin d&#8217;ex√©cuter un n≈ìud d&#8217;index complet faisant autorit√©, peut-√™tre parce qu&#8217;ils utilisent le n≈ìud pour exploiter une entreprise bitcoin.</p>
</div>
<div class="paragraph data-line-1030">
<p>Sans frais de transaction, la croissance des donn√©es bitcoin augmenterait sans doute de fa√ßon spectaculaire. Les frais sont destin√©s √† aligner les besoins des utilisateurs de bitcoins sur le fardeau que leurs transactions imposent au r√©seau, gr√¢ce √† un m√©canisme de d√©couverte des prix bas√© sur le march√©.</p>
</div>
<div class="paragraph data-line-1032">
<p>Le calcul des frais en fonction de la taille de la transaction traite toutes les donn√©es de la transaction comme ayant un co√ªt √©gal. Mais du point de vue des n≈ìuds complets et des mineurs, certaines parties d&#8217;une transaction entra√Ænent des co√ªts beaucoup plus √©lev√©s. Chaque transaction ajout√©e au r√©seau Bitcoin affecte la consommation de quatre ressources sur les n≈ìuds¬†:</p>
</div>
<div class="dlist data-line-1034">
<dl>
<dt class="hdlist1">Espace disque </dt>
<dd>
<p>Chaque transaction est stock√©e dans la cha√Æne de blocs, ajoutant √† la taille totale de la cha√Æne de blocs. La cha√Æne de blocs est stock√©e sur disque, mais le stockage peut √™tre optimis√© en ¬´ √©laguant ¬ª (supprimant) les anciennes transactions.</p>
</dd>
<dt class="hdlist1">CPU </dt>
<dd>
<p>Chaque transaction doit √™tre valid√©e, ce qui n√©cessite du temps CPU.</p>
</dd>
<dt class="hdlist1">Bande passante </dt>
<dd>
<p>Chaque transaction est transmise (par propagation d&#8217;inondation) sur le r√©seau au moins une fois. Sans aucune optimisation du protocole de propagation de bloc, les transactions sont √† nouveau transmises dans le cadre d&#8217;un bloc, ce qui double l&#8217;impact sur la capacit√© du r√©seau.</p>
</dd>
<dt class="hdlist1">M√©moire </dt>
<dd>
<p>Les n≈ìuds qui valident les transactions conservent l&#8217;index UTXO ou l&#8217;int√©gralit√© de l&#8217;ensemble UTXO en m√©moire pour acc√©l√©rer la validation. √âtant donn√© que la m√©moire est au moins un ordre de grandeur plus ch√®re que le disque, la croissance de l&#8217;ensemble UTXO contribue de mani√®re disproportionn√©e au co√ªt d&#8217;ex√©cution d&#8217;un n≈ìud.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-1042">
<p>Comme vous pouvez le voir dans la liste, toutes les parties d&#8217;une transaction n&#8217;ont pas le m√™me impact sur le co√ªt d&#8217;ex√©cution d&#8217;un n≈ìud ou sur la capacit√© du bitcoin √† √©voluer pour prendre en charge davantage de transactions. La partie la plus co√ªteuse d&#8217;une transaction sont les sorties nouvellement cr√©√©es, car elles sont ajout√©es √† l&#8217;ensemble UTXO en m√©moire. En comparaison, les signatures (c&#8217;est-√†-dire les donn√©es t√©moins) ajoutent le moins de charge au r√©seau et au co√ªt d&#8217;ex√©cution d&#8217;un n≈ìud, car les donn√©es t√©moins ne sont valid√©es qu&#8217;une seule fois et ne sont jamais r√©utilis√©es. De plus, imm√©diatement apr√®s avoir re√ßu une nouvelle transaction et valid√© les donn√©es t√©moins, les n≈ìuds peuvent supprimer ces donn√©es t√©moins. Si les frais sont calcul√©s en fonction de la taille de la transaction, sans faire de distinction entre ces deux types de donn√©es, les incitations du march√© en mati√®re de frais ne sont pas align√©es sur les co√ªts r√©els impos√©s par une transaction. En fait, la structure tarifaire actuelle encourage en fait le comportement inverse, car les donn√©es des t√©moins constituent la plus grande partie d&#8217;une transaction.</p>
</div>
<div class="paragraph data-line-1044">
<p>Les incitations cr√©√©es par les frais sont importantes car elles affectent le comportement des portefeuilles. Tous les portefeuilles doivent mettre en ≈ìuvre une strat√©gie pour assembler les transactions qui prend en consid√©ration un certain nombre de facteurs, tels que la confidentialit√© (r√©duction de la r√©utilisation des adresses), la fragmentation (faire beaucoup de monnaie) et les frais. Si les frais motivent massivement les portefeuilles √† utiliser le moins d&#8217;entr√©es possible dans les transactions, cela peut conduire √† la s√©lection d&#8217;UTXO et √† la modification des strat√©gies d&#8217;adresse qui gonflent par inadvertance l&#8217;ensemble UTXO.</p>
</div>
<div class="paragraph data-line-1046">
<p>Les transactions consomment les UTXO dans leurs entr√©es et cr√©ent de nouveaux UTXO avec leurs sorties. Par cons√©quent, une transaction qui a plus d&#8217;entr√©es que de sorties entra√Ænera une diminution de l&#8217;ensemble UTXO, tandis qu&#8217;une transaction qui a plus de sorties que d&#8217;entr√©es entra√Ænera une augmentation de l&#8217;ensemble UTXO. Consid√©rons la <em>difference</em> entre les entr√©es et les sorties et appelons cela le "Net-new-UTXO". Il s&#8217;agit d&#8217;une mesure importante, car elle nous indique l&#8217;impact qu&#8217;une transaction aura sur la ressource la plus ch√®re √† l&#8217;√©chelle du r√©seau, l&#8217;ensemble UTXO en m√©moire. Une transaction avec Net-new-UTXO positif ajoute √† ce fardeau. Une transaction avec un Net-new-UTXO n√©gatif r√©duit la charge. Nous voudrions donc encourager les transactions qui sont soit Net-new-UTXO n√©gatives, soit neutres avec z√©ro Net-new-UTXO.</p>
</div>
<div class="paragraph data-line-1048">
<p>Examinons un exemple des incitations cr√©√©es par le calcul des frais de transaction, avec et sans t√©moin s√©par√©. Nous examinerons deux transactions diff√©rentes. La transaction A est une transaction √† 3 entr√©es et 2 sorties, qui a une m√©trique Net-new-UTXO de -1, ce qui signifie qu&#8217;elle consomme un UTXO de plus qu&#8217;elle n&#8217;en cr√©e, ce qui r√©duit l&#8217;UTXO d√©fini d&#8217;un. La transaction B est une transaction √† 2 entr√©es et 3 sorties, qui a une m√©trique Net-new-UTXO de 1, ce qui signifie qu&#8217;elle ajoute un UTXO √† l&#8217;ensemble UTXO, imposant un co√ªt suppl√©mentaire √† l&#8217;ensemble du r√©seau Bitcoin. Les deux transactions utilisent des scripts multisignatures (2 sur 3) pour d√©montrer comment des scripts complexes augmentent l&#8217;impact d&#8217;un t√©moin s√©par√© sur les frais. Supposons un taux de transaction de 30¬†satoshi par octet et une remise de 75¬†% sur les donn√©es des t√©moins¬†:</p>
</div>
<dl>
<dt>Sans t√©moin s√©par√©</dt>
<dd>
<p>Frais de transaction A¬†: 28 590 satoshi</p>
<p>Frais de transaction B¬†: 20 760 satoshi</p>
</dd>

<dt>Avec t√©moin s√©par√©</dt>
<dd>
<p>Frais de transaction A¬†: 12 255 satoshi</p>
<p>Frais de transaction B¬†: 10 425 satoshi</p>
</dd>
</dl>
<div class="paragraph data-line-1067">
<p>Les deux transactions sont moins co√ªteuses lorsque le t√©moin s√©par√© est mis en ≈ìuvre. En comparant les co√ªts entre les deux transactions, nous voyons qu&#8217;avant le t√©moin s√©par√©, la transaction avec le Net-new-UTXO positif permet de r√©aliser d&#8217;importantes √©conomies. Avec le t√©moin s√©par√©, la diff√©rence de co√ªt diminue consid√©rablement en termes absolus et relatifs. Bien qu&#8217;il faudrait que les intrants deviennent moins chers que les extrants pour inciter √† la consolidation de l&#8217;ensemble UTXO, cette remise r√©duit l&#8217;incitation √† cr√©er de nouveaux UTXO afin d&#8217;√©viter d&#8217;utiliser plus d&#8217;intrants.</p>
</div>
<div class="paragraph data-line-1069">
<p>Le t√©moin s√©par√© a donc deux effets principaux sur les frais pay√©s par les utilisateurs de bitcoin. Premi√®rement, segwit r√©duit le co√ªt global des transactions en actualisant les donn√©es des t√©moins et en augmentant la capacit√© de la cha√Æne de blocs Bitcoin. Deuxi√®mement, la remise de segwit sur les donn√©es des t√©moins att√©nue partiellement un d√©salignement des incitations qui peut avoir cr√©√© par inadvertance plus de ballonnement dans l&#8217;ensemble UTXO.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-03-23 23:57:01 -0400
</div>
</div>
</body>
</html>